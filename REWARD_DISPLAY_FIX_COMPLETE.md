# æ”¶ç›Šæ˜ç»†ç›´æ¨å’Œå±‚çº§å¥–åŠ±æ˜¾ç¤ºé—®é¢˜ - å®Œæ•´è§£å†³æ–¹æ¡ˆ

## é—®é¢˜è¯Šæ–­ç»“æœ

### æ ¹æœ¬åŸå› 
é€šè¿‡æ·±å…¥åˆ†æä»£ç å’Œè¿è¡Œè¯Šæ–­è„šæœ¬ï¼Œç¡®è®¤é—®é¢˜å‡ºç°åœ¨ **Teståˆ†æ”¯åˆçº¦å®ç°** ä¸­ï¼š

1. **åˆçº¦åœ°å€å¯¹æ¯”**:
   - Teståˆ†æ”¯: `0xD437e63c2A76e0237249eC6070Bef9A2484C4302` (60ç§’æ—¶é—´å•ä½)
   - P-prodåˆ†æ”¯: `0x515871E9eADbF976b546113BbD48964383f86E61` (86400ç§’æ—¶é—´å•ä½)

2. **æ ¸å¿ƒé—®é¢˜**: Teståˆ†æ”¯åˆçº¦çš„ `_distributeReward` å‡½æ•°å­˜åœ¨bugï¼Œå¯¼è‡´ï¼š
   - ç›´æ¨å¥–åŠ±é€»è¾‘å­˜åœ¨ä½†ä¸è§¦å‘ `ReferralRewardPaid` äº‹ä»¶
   - å±‚çº§å¥–åŠ±é€»è¾‘å­˜åœ¨ä½†ä¸è§¦å‘ `ReferralRewardPaid` äº‹ä»¶
   - è¯Šæ–­è„šæœ¬ç¡®è®¤ï¼š50,000ä¸ªåŒºå—ä¸­æœ‰é—¨ç¥¨è´­ä¹°ä½†0ä¸ªå¥–åŠ±äº‹ä»¶

3. **å‰ç«¯å®ç°æ­£ç¡®**: `EarningsDetail.tsx` çš„äº‹ä»¶è§£æé€»è¾‘å®Œå…¨æ­£ç¡®ï¼Œæ”¯æŒæ–°æ—§ä¸¤ç§äº‹ä»¶æ ¼å¼

## è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºå‡çº§åˆçº¦ `JinbaoProtocolV2.sol`

**å…³é”®ä¿®å¤**:
- âœ… ä¿®å¤ `_distributeReward` å‡½æ•°ï¼Œç¡®ä¿äº‹ä»¶å¿…å®šè§¦å‘
- âœ… é‡å†™ `buyTicket` å‡½æ•°ï¼Œä¿è¯ç›´æ¨å¥–åŠ±äº‹ä»¶å‘å‡º
- âœ… é‡å†™ `_distributeTicketLevelRewardsV2`ï¼Œä¿è¯å±‚çº§å¥–åŠ±äº‹ä»¶å‘å‡º
- âœ… æ·»åŠ è°ƒè¯•äº‹ä»¶ `RewardDistributionDebug` ç”¨äºé—®é¢˜æ’æŸ¥
- âœ… æ”¯æŒæ–°çš„6å‚æ•° `ReferralRewardPaid` äº‹ä»¶æ ¼å¼
- âœ… å¢å¼ºé”™è¯¯å¤„ç†å’ŒçŠ¶æ€å›æ»šæœºåˆ¶

**æ ¸å¿ƒä¿®å¤ä»£ç **:
```solidity
// ğŸ”¥ CRITICAL FIX: Always emit ReferralRewardPaid event when there's a valid referrer
if (directAmt > 0) {
    // Use new 6-parameter format for better tracking
    emit ReferralRewardPaid(referrerAddr, msg.sender, paid, 0, REWARD_DIRECT, t.ticketId);
    
    // Debug event for troubleshooting
    emit RewardDistributionDebug(referrerAddr, directAmt, REWARD_DIRECT, paid > 0, 
        paid > 0 ? "Direct reward paid" : "Direct reward capped or failed");
}
```

### 2. éƒ¨ç½²è„šæœ¬ `scripts/upgrade-protocol-v2.js`

**åŠŸèƒ½**:
- ä½¿ç”¨OpenZeppelinçš„UUPSå‡çº§æ¨¡å¼
- ä¿æŒä»£ç†åˆçº¦åœ°å€ä¸å˜
- éªŒè¯å‡çº§ç»“æœå’Œé…ç½®
- æä¾›å‡çº§åçš„æ“ä½œæŒ‡å—

### 3. æµ‹è¯•è„šæœ¬ `test-upgrade-v2.js`

**éªŒè¯å†…å®¹**:
- åˆçº¦ç‰ˆæœ¬ç¡®è®¤ (åº”ä¸º "2.0.0")
- åŸºæœ¬é…ç½®æ£€æŸ¥
- å¥–åŠ±äº‹ä»¶æŸ¥è¯¢å’Œæ ¼å¼éªŒè¯
- è°ƒè¯•äº‹ä»¶ç›‘æ§

## æ‰§è¡Œæ­¥éª¤

### 1. ç¼–è¯‘æ–°åˆçº¦
```bash
npm run compile
```

### 2. æ‰§è¡Œå‡çº§
```bash
npx hardhat run scripts/upgrade-protocol-v2.js --network mc
```

### 3. éªŒè¯å‡çº§
```bash
node test-upgrade-v2.js
```

### 4. æµ‹è¯•åŠŸèƒ½
1. è®©æœ‰æ¨èäººçš„ç”¨æˆ·è´­ä¹°é—¨ç¥¨
2. æ£€æŸ¥æ˜¯å¦è§¦å‘ `ReferralRewardPaid` äº‹ä»¶
3. åœ¨å‰ç«¯æ”¶ç›Šæ˜ç»†é¡µé¢éªŒè¯æ˜¾ç¤º

## é¢„æœŸç»“æœ

### å‡çº§ååº”è¯¥çœ‹åˆ°:
1. âœ… åˆçº¦ç‰ˆæœ¬æ˜¾ç¤ºä¸º "2.0.0"
2. âœ… è´­ä¹°é—¨ç¥¨æ—¶è§¦å‘ `ReferralRewardPaid` äº‹ä»¶
3. âœ… æ”¶ç›Šæ˜ç»†é¡µé¢æ­£å¸¸æ˜¾ç¤ºç›´æ¨å¥–åŠ± (rewardType: 2)
4. âœ… æ”¶ç›Šæ˜ç»†é¡µé¢æ­£å¸¸æ˜¾ç¤ºå±‚çº§å¥–åŠ± (rewardType: 3)
5. âœ… æ–°çš„6å‚æ•°äº‹ä»¶æ ¼å¼: `ReferralRewardPaid(user, from, mcAmount, jbcAmount, rewardType, ticketId)`
6. âœ… è°ƒè¯•äº‹ä»¶å¸®åŠ©ç›‘æ§å¥–åŠ±åˆ†å‘çŠ¶æ€

### å‰ç«¯æ˜¾ç¤ºä¿®å¤:
- ç›´æ¨å¥–åŠ±å¡ç‰‡æ˜¾ç¤ºéé›¶æ•°å€¼
- å±‚çº§å¥–åŠ±å¡ç‰‡æ˜¾ç¤ºéé›¶æ•°å€¼
- æ”¶ç›Šè®°å½•åˆ—è¡¨åŒ…å«ç›´æ¨å’Œå±‚çº§å¥–åŠ±æ¡ç›®
- äº‹ä»¶è§£ææ­£ç¡®å¤„ç†æ–°æ—§ä¸¤ç§æ ¼å¼

## æŠ€æœ¯ç»†èŠ‚

### å¥–åŠ±ç±»å‹å®šä¹‰:
```solidity
uint8 public constant REWARD_STATIC = 0;      // é™æ€å¥–åŠ±
uint8 public constant REWARD_DYNAMIC = 1;     // åŠ¨æ€å¥–åŠ± (å·²å¼ƒç”¨)
uint8 public constant REWARD_DIRECT = 2;      // ç›´æ¨å¥–åŠ±
uint8 public constant REWARD_LEVEL = 3;       // å±‚çº§å¥–åŠ±
uint8 public constant REWARD_DIFFERENTIAL = 4; // çº§å·®å¥–åŠ±
```

### äº‹ä»¶æ ¼å¼:
```solidity
// æ–°æ ¼å¼ (V2)
event ReferralRewardPaid(
    address indexed user,    // æ¥æ”¶å¥–åŠ±çš„ç”¨æˆ·
    address indexed from,    // å¥–åŠ±æ¥æºç”¨æˆ·
    uint256 mcAmount,        // MCå¥–åŠ±æ•°é‡
    uint256 jbcAmount,       // JBCå¥–åŠ±æ•°é‡
    uint8 rewardType,        // å¥–åŠ±ç±»å‹
    uint256 ticketId         // ç›¸å…³é—¨ç¥¨ID
);

// è°ƒè¯•äº‹ä»¶ (V2æ–°å¢)
event RewardDistributionDebug(
    address indexed user,
    uint256 amount,
    uint8 rewardType,
    bool success,
    string reason
);
```

## é£é™©è¯„ä¼°

### ä½é£é™©:
- âœ… ä½¿ç”¨æˆç†Ÿçš„UUPSå‡çº§æ¨¡å¼
- âœ… ä¿æŒæ‰€æœ‰å­˜å‚¨å˜é‡ä¸å˜
- âœ… å‘åå…¼å®¹ç°æœ‰åŠŸèƒ½
- âœ… åªä¿®å¤bugï¼Œä¸æ”¹å˜ä¸šåŠ¡é€»è¾‘

### å»ºè®®ç›‘æ§:
- å‡çº§å24å°æ—¶å†…å¯†åˆ‡ç›‘æ§åˆçº¦è¿è¡Œ
- æ£€æŸ¥å¥–åŠ±åˆ†å‘æ˜¯å¦æ­£å¸¸
- ç›‘æ§è°ƒè¯•äº‹ä»¶äº†è§£ç³»ç»ŸçŠ¶æ€
- éªŒè¯å‰ç«¯æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®

## æ€»ç»“

è¿™ä¸ªå‡çº§ä¸“é—¨è§£å†³äº†Teståˆ†æ”¯åˆçº¦ä¸­ç›´æ¨å’Œå±‚çº§å¥–åŠ±äº‹ä»¶ä¸è§¦å‘çš„é—®é¢˜ã€‚é€šè¿‡é‡å†™å…³é”®å‡½æ•°å¹¶æ·»åŠ å¼ºåˆ¶äº‹ä»¶å‘å‡ºæœºåˆ¶ï¼Œç¡®ä¿å‰ç«¯èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰å››ç§å¥–åŠ±ç±»å‹ï¼š

1. âœ… **é™æ€å¥–åŠ±** - å·²æ­£å¸¸å·¥ä½œ
2. âœ… **ç›´æ¨å¥–åŠ±** - å‡çº§åä¿®å¤
3. âœ… **å±‚çº§å¥–åŠ±** - å‡çº§åä¿®å¤  
4. âœ… **çº§å·®å¥–åŠ±** - å·²æ­£å¸¸å·¥ä½œ

å‡çº§å®Œæˆåï¼Œç”¨æˆ·åœ¨æ”¶ç›Šæ˜ç»†é¡µé¢å°†èƒ½çœ‹åˆ°å®Œæ•´çš„å¥–åŠ±å†å²è®°å½•ã€‚