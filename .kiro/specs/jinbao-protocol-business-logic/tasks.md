# Jinbao Protocol 业务逻辑实现任务

## 任务概述

本任务列表基于Jinbao Protocol的完整业务逻辑需求，将系统实现分解为可执行的开发任务。所有任务都基于已完成的原生MC代币迁移架构。

## 任务分类

### 1. 门票系统实现

- [ ] 1.1 实现门票购买核心逻辑
  - 实现 `buyTicket()` payable函数
  - 验证门票金额（100/300/500/1000 MC）
  - 处理门票状态（新建/累加/重新激活）
  - 设置收益上限（门票金额×3）
  - 更新最大门票记录
  - _需求: 1.1, 1.3, 1.4, 1.5_

- [ ]* 1.2 编写门票购买属性测试
  - **属性1: 门票金额验证**
  - **验证需求: 1.1**

- [ ]* 1.3 编写收益上限计算属性测试  
  - **属性2: 收益上限计算**
  - **验证需求: 1.3**

- [ ] 1.4 实现门票过期机制
  - 实现 `_expireTicketIfNeeded()` 内部函数
  - 检查过期条件（72小时+无活跃质押）
  - 清理过期门票数据
  - 更新用户活跃状态
  - _需求: 1.2_

- [ ]* 1.5 编写门票过期属性测试
  - **属性3: 门票过期机制**
  - **验证需求: 1.2**

- [ ] 1.6 实现门票状态管理
  - 实现门票ID生成和管理
  - 实现门票拥有者映射
  - 实现门票查询接口
  - _需求: 1.3_

### 2. MC代币系统实现

- [ ] 2.1 实现原生MC代币处理机制
  - 实现 `receive()` payable函数
  - 实现 `_transferNativeMC()` 安全转账函数
  - 添加原生MC余额验证修饰符
  - 处理转账失败情况
  - _需求: 2.1, 2.3, 2.4_

- [ ]* 2.2 编写原生MC处理属性测试
  - **属性4: 原生MC安全转账**
  - **验证需求: 2.4**

- [ ] 2.3 实现MC资金分配机制
  - 实现资金分配逻辑（25%直推+15%级差+60%系统）
  - 实现各钱包地址配置
  - 实现分配比例管理
  - 确保分配总和为100%
  - _需求: 2.2_

- [ ]* 2.4 编写资金分配属性测试
  - **属性5: 资金分配比例**
  - **验证需求: 2.2**

- [ ] 2.5 实现MC余额管理
  - 集成原生MC余额查询
  - 实现余额验证逻辑
  - 处理余额不足错误
  - _需求: 2.3_

### 3. JBC代币系统实现

- [ ] 3.1 实现JBC代币基础功能
  - 确认JBC ERC20接口实现
  - 实现铸造和燃烧权限控制
  - 实现JBC余额查询
  - _需求: 3.1, 3.2_

- [ ]* 3.2 编写JBC基础功能测试
  - **示例1: JBC ERC20合规性**
  - **验证需求: 3.1**

- [ ] 3.3 实现JBC价格计算机制
  - 实现 `_getCurrentJBCPrice()` 函数
  - 实现价格保护机制（0.1-10 MC范围）
  - 处理流动性不足情况
  - _需求: 3.4_

- [ ]* 3.4 编写JBC价格计算属性测试
  - **属性6: JBC价格计算公式**
  - **验证需求: 3.4**

- [ ]* 3.5 编写JBC价格保护属性测试
  - **属性7: JBC价格边界保护**
  - **验证需求: 3.4**

- [ ] 3.6 实现JBC销毁机制
  - 实现交换税收销毁
  - 实现每日销毁功能 `dailyBurn()`
  - 实现回购销毁 `_internalBuybackAndBurn()`
  - 24小时间隔控制
  - _需求: 3.3_

- [ ]* 3.7 编写JBC销毁机制属性测试
  - **属性8: JBC销毁税收计算**
  - **验证需求: 3.3**

### 4. AMM交换系统实现

- [ ] 4.1 实现AMM核心交换逻辑
  - 实现 `swapMCToJBC()` payable函数
  - 实现 `swapJBCToMC()` 函数
  - 实现恒定乘积公式 (x*y=k)
  - 更新储备量
  - _需求: 4.1, 4.2_

- [ ]* 4.2 编写AMM交换属性测试
  - **属性9: 恒定乘积公式**
  - **验证需求: 4.1**

- [ ] 4.3 实现交换税费机制
  - MC→JBC交换50%税费
  - JBC→MC交换25%税费
  - 税费自动销毁
  - 税费比例管理
  - _需求: 4.2_

- [ ]* 4.4 编写交换税费属性测试
  - **属性10: 交换税费计算**
  - **验证需求: 4.2**

- [ ] 4.5 实现价格影响保护
  - 实现价格影响计算
  - 设置10%最大价格影响限制
  - 拒绝超限交换
  - _需求: 4.3_

- [ ]* 4.6 编写价格影响保护属性测试
  - **属性11: 价格影响限制**
  - **验证需求: 4.3**

- [ ] 4.7 实现流动性管理
  - 实现 `addLiquidity()` 管理员函数
  - 实现 `withdrawSwapReserves()` 函数
  - 最小流动性阈值检查
  - 流动性操作权限控制
  - _需求: 4.4_

- [ ]* 4.8 编写流动性管理属性测试
  - **属性12: 流动性管理权限**
  - **验证需求: 4.4**

### 5. 奖励系统实现

- [ ] 5.1 实现静态奖励机制
  - 实现质押功能 `stakeLiquidity()`
  - 实现收益计算 `_calculateStakeReward()`
  - 支持7/15/30天周期
  - 实现1.33%/1.67%/2.00%日收益率
  - _需求: 5.1_

- [ ]* 5.2 编写静态奖励属性测试
  - **属性13: 静态收益率计算**
  - **验证需求: 5.1**

- [ ] 5.3 实现奖励分配机制
  - 实现50% MC + 50% JBC价值分配
  - 实现 `claimRewards()` 函数
  - 处理合约余额不足情况
  - _需求: 5.2_

- [ ]* 5.4 编写奖励分配属性测试
  - **属性14: 奖励分配比例**
  - **验证需求: 5.2**

- [ ] 5.5 实现直推奖励机制
  - 从门票购买中分配25%直推奖励
  - 验证推荐人活跃状态
  - 处理无推荐人情况
  - _需求: 5.3_

- [ ]* 5.6 编写直推奖励属性测试
  - **属性15: 直推奖励计算**
  - **验证需求: 5.3**

- [ ] 5.7 实现级差奖励机制
  - 根据活跃直推数确定奖励层数
  - 实现15层级差奖励分配
  - 每层1%奖励计算
  - 未分配奖励进入奖励池
  - _需求: 5.4_

- [ ]* 5.8 编写级差奖励属性测试
  - **属性16: 级差奖励层数计算**
  - **验证需求: 5.4**

- [ ] 5.9 实现团队等级系统
  - 实现V0-V9九级等级系统
  - 实现 `_getLevel()` 函数
  - 团队人数到等级映射
  - 等级变化事件触发
  - _需求: 5.5_

- [ ]* 5.10 编写团队等级属性测试
  - **属性17: 团队等级映射**
  - **验证需求: 5.5**

- [ ] 5.11 实现极差奖励机制
  - 实现极差奖励计算和存储
  - 实现 `_calculateAndStoreDifferentialRewards()`
  - 实现 `_releaseDifferentialRewards()`
  - 50% MC + 50% JBC价值分配
  - _需求: 5.6_

- [ ]* 5.12 编写极差奖励属性测试
  - **属性18: 极差奖励分配**
  - **验证需求: 5.6**

### 6. 用户管理系统实现

- [ ] 6.1 实现用户状态管理
  - 实现UserInfo数据结构
  - 实现用户状态查询接口
  - 实现状态更新逻辑
  - _需求: 6.1_

- [ ]* 6.2 编写用户状态管理属性测试
  - **属性19: 用户状态完整性**
  - **验证需求: 6.1**

- [ ] 6.3 实现推荐关系管理
  - 实现 `bindReferrer()` 函数
  - 一次性绑定限制
  - 自我推荐防护
  - 循环推荐检测
  - _需求: 6.2, 6.3_

- [ ]* 6.4 编写推荐关系属性测试
  - **属性20: 推荐关系唯一性**
  - **验证需求: 6.2**

- [ ]* 6.5 编写推荐安全属性测试
  - **属性21: 推荐关系安全性**
  - **验证需求: 6.3**

- [ ] 6.6 实现活跃状态管理
  - 实现 `_updateActiveStatus()` 函数
  - 活跃状态判断逻辑
  - 直推计数自动更新
  - _需求: 6.4_

- [ ]* 6.7 编写活跃状态属性测试
  - **属性22: 活跃状态判断**
  - **验证需求: 6.4**

### 7. 赎回和退出系统实现

- [ ] 7.1 实现主动赎回功能
  - 实现 `redeem()` 函数
  - 质押到期检查
  - 收益计算和发放
  - 1%赎回费用计算
  - _需求: 7.1, 7.2_

- [ ]* 7.2 编写赎回功能属性测试
  - **属性23: 赎回时机控制**
  - **验证需求: 7.1**

- [ ]* 7.3 编写赎回费用属性测试
  - **属性24: 赎回费用计算**
  - **验证需求: 7.2**

- [ ] 7.4 实现自动退出机制
  - 实现 `_handleExit()` 函数
  - 收益上限检查
  - 自动退出触发
  - 状态清理和更新
  - _需求: 7.3_

- [ ]* 7.5 编写自动退出属性测试
  - **属性25: 自动退出触发**
  - **验证需求: 7.3**

- [ ] 7.6 实现费用处理机制
  - 费用存储和退还逻辑
  - 费用添加到储备
  - 下次质押时自动退还
  - _需求: 7.3_

### 8. 安全和管理系统实现

- [ ] 8.1 实现安全保护机制
  - 集成ReentrancyGuard重入保护
  - 实现输入参数验证
  - 实现安全转账机制
  - 异常处理和错误定义
  - _需求: 8.1_

- [ ]* 8.2 编写安全保护属性测试
  - **属性26: 重入攻击防护**
  - **验证需求: 8.1**

- [ ] 8.3 实现紧急管理功能
  - 实现 `emergencyPause()` 和 `emergencyUnpause()`
  - 实现紧急提取功能
  - 实现代币救援功能
  - _需求: 8.2_

- [ ]* 8.4 编写紧急管理测试
  - **示例2: 紧急暂停功能**
  - **验证需求: 8.2**

- [ ] 8.5 实现权限控制系统
  - 集成Ownable权限控制
  - 管理员功能访问限制
  - 权限验证逻辑
  - _需求: 8.3_

- [ ]* 8.6 编写权限控制属性测试
  - **属性27: 管理员权限控制**
  - **验证需求: 8.3**

### 9. 性能优化实现

- [ ] 9.1 实现Gas优化
  - 原生MC代币使用优化
  - 存储操作优化
  - 循环限制保护
  - 批量操作实现
  - _需求: 9.1_

- [ ]* 9.2 编写Gas优化属性测试
  - **属性28: 交易步骤优化**
  - **验证需求: 9.1**

- [ ] 9.3 实现流动性保护
  - 最小流动性阈值设置
  - 流动性影响限制
  - 保护机制触发
  - _需求: 9.2_

- [ ]* 9.4 编写流动性保护属性测试
  - **属性29: 流动性阈值保护**
  - **验证需求: 9.2**

- [ ] 9.5 实现系统稳定性
  - 边界情况处理
  - 异常状态恢复
  - 数据一致性保证
  - _需求: 9.3_

- [ ]* 9.6 编写系统稳定性属性测试
  - **属性30: 系统异常处理**
  - **验证需求: 9.3**

### 10. 集成和测试

- [ ] 10.1 实现完整集成测试
  - 端到端用户流程测试
  - 多用户交互测试
  - 系统状态一致性测试
  - 性能基准测试

- [ ] 10.2 实现部署和配置
  - 生产部署脚本完善
  - 配置参数管理
  - 初始化流程验证
  - 升级机制测试

- [ ] 10.3 系统验收测试
  - 所有功能完整性验证
  - 安全性审计
  - 性能指标验证
  - 用户体验测试

## 检查点

- [ ] 检查点1: 门票和MC系统完成
  - 确保门票购买、MC处理、资金分配功能正常
  - 运行相关属性测试验证正确性
  - 询问用户是否有问题

- [ ] 检查点2: JBC和AMM系统完成  
  - 确保JBC代币、AMM交换、价格机制功能正常
  - 运行相关属性测试验证正确性
  - 询问用户是否有问题

- [ ] 检查点3: 奖励系统完成
  - 确保静态、直推、级差、极差奖励功能正常
  - 运行相关属性测试验证正确性
  - 询问用户是否有问题

- [ ] 检查点4: 用户管理和安全系统完成
  - 确保用户管理、赎回退出、安全机制功能正常
  - 运行相关属性测试验证正确性
  - 询问用户是否有问题

- [ ] 最终检查点: 系统集成完成
  - 确保所有测试通过，询问用户是否有问题

## 注意事项

### 开发原则
- 基于已完成的原生MC代币迁移架构
- 保持所有现有功能和分配机制不变
- 确保向后兼容性
- 优先考虑安全性和用户体验

### 测试策略
- 每个核心功能都有对应的属性测试
- 属性测试验证通用规则和边界条件
- 示例测试验证特定场景和配置
- 集成测试验证端到端流程

### 质量标准
- 100%核心功能测试覆盖
- 所有属性测试必须通过
- Gas使用优化验证
- 安全漏洞零容忍

---

**任务版本**: 1.0  
**最后更新**: 2024年12月29日  
**状态**: ✅ **任务规划完成，准备开始实施**