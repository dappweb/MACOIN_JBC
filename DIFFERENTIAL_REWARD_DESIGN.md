# æå·®å¥–åŠ±æœºåˆ¶è®¾è®¡æ–‡æ¡£

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

æ ¹æ®ç™½çš®ä¹¦ç¬¬å››èŠ‚"æå·®è£‚å˜æœºåˆ¶"ï¼Œå®ç°V1-V9çš„æå·®å¥–åŠ±åˆ†é…ã€‚

---

## ğŸ¯ æ ¸å¿ƒé€»è¾‘

### 1. å¹³çº§åˆ¤æ–­è§„åˆ™

**å…³é”®ç‚¹**ï¼š
- æå·®å¥–åŠ±å‘ä¸Šéå†æ¨èé“¾
- **åªæœ‰å½“ä¸Šçº§çš„ç­‰çº§ > ä¸‹çº§çš„ç­‰çº§æ—¶ï¼Œä¸Šçº§æ‰èƒ½è·å¾—æå·®å¥–åŠ±**
- æå·®å¥–åŠ± = (ä¸Šçº§ç­‰çº§æ¯”ä¾‹ - ä¸‹çº§ç­‰çº§æ¯”ä¾‹) Ã— é—¨ç¥¨é‡‘é¢

### 2. ç­‰çº§ç³»ç»Ÿ

| ç­‰çº§ | è¦æ±‚æœ‰æ•ˆåœ°å€æ•° | æå·®å¥–åŠ±æ¯”ä¾‹ |
|------|--------------|------------|
| V0   | 0            | 0%         |
| V1   | 10           | 5%         |
| V2   | 30           | 10%        |
| V3   | 100          | 15%        |
| V4   | 300          | 20%        |
| V5   | 1000         | 25%        |
| V6   | 3000         | 30%        |
| V7   | 10000        | 35%        |
| V8   | 30000        | 40%        |
| V9   | 100000       | 45%        |

---

## ğŸ“Š æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹1ï¼šåŒä¸€æ¡çº¿çš„å¹³çº§é—®é¢˜

**åœºæ™¯**ï¼š
```
ä½  (V1, 10ä¸ªç›´æ¨)
 â””â”€ A (ä½ çš„ç›´æ¨, V2, 30ä¸ªæœ‰æ•ˆåœ°å€)
     â””â”€ B (Açš„ç›´æ¨, è´­ä¹°100MCé—¨ç¥¨)
```

**é—®é¢˜**ï¼šä½ å’ŒAåœ¨åŒä¸€æ¡æ¨èçº¿ä¸Šï¼ŒAçš„ç­‰çº§æ¯”ä½ é«˜ï¼Œä½ æ˜¯å¦èƒ½è·å¾—Aå›¢é˜Ÿçš„æå·®å¥–åŠ±ï¼Ÿ

**ç­”æ¡ˆ**ï¼šâŒ **ä¸èƒ½**

**åŸå› **ï¼š
- ä½ æ˜¯V1 (5%)
- Aæ˜¯V2 (10%)
- ä½ çš„ç­‰çº§ < Açš„ç­‰çº§
- æå·® = 5% - 10% = -5% (è´Ÿæ•°)
- **è´Ÿæ•°æå·® = 0ï¼Œä¸è·å¾—å¥–åŠ±**

### æ¡ˆä¾‹2ï¼šä½ å‡çº§ååè¶…

**åœºæ™¯**ï¼š
```
ä½  (V3, 100ä¸ªæœ‰æ•ˆåœ°å€) â† å‡çº§äº†ï¼
 â””â”€ A (V2, 30ä¸ªæœ‰æ•ˆåœ°å€)
     â””â”€ B (è´­ä¹°100MCé—¨ç¥¨)
```

**ç»“æœ**ï¼šâœ… **ä½ è·å¾—æå·®å¥–åŠ±**

**è®¡ç®—**ï¼š
```
Bè´­ä¹°é—¨ç¥¨: 100 MC

1. ç›´æ¨å¥–åŠ±: 25 MC â†’ A

2. æå·®å¥–åŠ±:
   - Aæ˜¯V2 (10%)ï¼Œè·å¾— 10% Ã— 100 = 10 MC
   - ä½†Aå·²ç»æ‹¿äº†25MCç›´æ¨å¥–åŠ±ï¼Œæå·®æ˜¯å¦å åŠ ï¼Ÿ

   âš ï¸ é‡è¦é—®é¢˜ï¼šæå·®å¥–åŠ±æ˜¯åŸºäºä»€ä¹ˆé‡‘é¢è®¡ç®—ï¼Ÿ
   - é€‰é¡¹Aï¼šåŸºäºé—¨ç¥¨æ€»é‡‘é¢ (100 MC)
   - é€‰é¡¹Bï¼šåŸºäºå‰©ä½™é‡‘é¢ (æ‰£é™¤ç›´æ¨å¥–åŠ±å)

   å‡è®¾é€‰é¡¹Aï¼ˆæ›´å¸¸è§ï¼‰ï¼š

   - Aåº”å¾—æå·®: 10% Ã— 100 = 10 MC
   - ä½ åº”å¾—æå·®: 15% Ã— 100 = 15 MC

   - Aå®é™…è·å¾—æå·®: 10 MC
   - ä½ è·å¾—æå·®: 15% - 10% = 5% Ã— 100 = 5 MC

âœ… ä½ è·å¾— 5 MC
```

### æ¡ˆä¾‹3ï¼šå¤šå±‚çº§æå·®åˆ†é…

**åœºæ™¯**ï¼š
```
V5å¤§ä½¬ (25%) â† æœ€ä¸Šçº§
 â””â”€ V3ä½  (15%)
     â””â”€ V2-A (10%)
         â””â”€ V1-B (5%)
             â””â”€ V0-C (è´­ä¹°100MCé—¨ç¥¨)
```

**å®Œæ•´å¥–åŠ±åˆ†é…**ï¼š

```
Cè´­ä¹°100MCé—¨ç¥¨ï¼š

1. ç›´æ¨å¥–åŠ± (25%):
   - Cçš„ç›´æ¨äººè·å¾— 25 MC

2. å±‚çº§å¥– (15%):
   - æ ¹æ®æ¨èäººæ•°è®¡ç®—ï¼ˆå¾…å®ç°ï¼‰

3. æå·®å¥–åŠ± (é€å±‚è®¡ç®—):

   ç¬¬1å±‚ï¼šC (V0, 0%) â†’ B (V1, 5%)
   - Bè·å¾—: (5% - 0%) Ã— 100 = 5 MC

   ç¬¬2å±‚ï¼šB (V1, 5%) â†’ A (V2, 10%)
   - Aè·å¾—: (10% - 5%) Ã— 100 = 5 MC

   ç¬¬3å±‚ï¼šA (V2, 10%) â†’ ä½  (V3, 15%)
   - ä½ è·å¾—: (15% - 10%) Ã— 100 = 5 MC

   ç¬¬4å±‚ï¼šä½  (V3, 15%) â†’ V5å¤§ä½¬ (25%)
   - å¤§ä½¬è·å¾—: (25% - 15%) Ã— 100 = 10 MC

   æ€»æå·®å¥–åŠ±: 5 + 5 + 5 + 10 = 25 MC
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. æ•°æ®ç»“æ„ä¿®æ”¹

```solidity
// åœ¨ JinbaoProtocol.sol ä¸­æ·»åŠ 

struct UserInfo {
    address referrer;        // æ¨èäºº
    uint256 activeDirects;   // æœ‰æ•ˆç›´æ¨æ•°
    uint256 teamCount;       // å›¢é˜Ÿæ€»äººæ•°
    uint256 totalRevenue;    // ç´¯è®¡æ”¶ç›Š
    uint256 currentCap;      // å½“å‰æ”¶ç›Šä¸Šé™
    bool isActive;           // æ˜¯å¦æ¿€æ´»
    uint8 level;            // V0-V9ç­‰çº§ (æ–°å¢)
}

// ç­‰çº§é…ç½®
struct LevelConfig {
    uint256 requiredAddresses;  // éœ€è¦çš„æœ‰æ•ˆåœ°å€æ•°
    uint8 rewardPercent;        // æå·®å¥–åŠ±æ¯”ä¾‹
}

mapping(uint8 => LevelConfig) public levelConfigs;
```

### 2. æ ¸å¿ƒå‡½æ•°

#### A. è·å–ç”¨æˆ·ç­‰çº§

```solidity
function getLevel(address user) public view returns (uint8) {
    uint256 activeDirects = userInfo[user].activeDirects;

    if (activeDirects >= 100000) return 9;  // V9
    if (activeDirects >= 30000) return 8;   // V8
    if (activeDirects >= 10000) return 7;   // V7
    if (activeDirects >= 3000) return 6;    // V6
    if (activeDirects >= 1000) return 5;    // V5
    if (activeDirects >= 300) return 4;     // V4
    if (activeDirects >= 100) return 3;     // V3
    if (activeDirects >= 30) return 2;      // V2
    if (activeDirects >= 10) return 1;      // V1
    return 0;  // V0
}
```

#### B. è·å–ç­‰çº§å¯¹åº”çš„å¥–åŠ±æ¯”ä¾‹

```solidity
function getLevelPercent(uint8 level) public pure returns (uint8) {
    if (level == 9) return 45;  // V9: 45%
    if (level == 8) return 40;  // V8: 40%
    if (level == 7) return 35;  // V7: 35%
    if (level == 6) return 30;  // V6: 30%
    if (level == 5) return 25;  // V5: 25%
    if (level == 4) return 20;  // V4: 20%
    if (level == 3) return 15;  // V3: 15%
    if (level == 2) return 10;  // V2: 10%
    if (level == 1) return 5;   // V1: 5%
    return 0;  // V0: 0%
}
```

#### C. åˆ†é…æå·®å¥–åŠ±ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰

```solidity
function _distributeDifferentialRewards(
    address buyer,
    uint256 ticketAmount
) internal {
    address current = userInfo[buyer].referrer;
    uint8 previousLevel = 0;  // ä»æœ€åº•å±‚å¼€å§‹

    // å‘ä¸Šéå†æ¨èé“¾ï¼Œæœ€å¤šéå†20å±‚
    for (uint256 i = 0; i < 20 && current != address(0); i++) {
        uint8 currentLevel = getLevel(current);

        // åªæœ‰å½“å½“å‰ç­‰çº§ > ä¹‹å‰çš„ç­‰çº§æ—¶ï¼Œæ‰å‘æ”¾æå·®å¥–åŠ±
        if (currentLevel > previousLevel) {
            uint8 previousPercent = getLevelPercent(previousLevel);
            uint8 currentPercent = getLevelPercent(currentLevel);

            // æå·®æ¯”ä¾‹
            uint8 differential = currentPercent - previousPercent;

            // è®¡ç®—å¥–åŠ±é‡‘é¢
            uint256 rewardAmount = (ticketAmount * differential) / 100;

            // æ£€æŸ¥æ”¶ç›Šä¸Šé™
            if (userInfo[current].totalRevenue + rewardAmount <= userInfo[current].currentCap) {
                // å‘æ”¾MCå¥–åŠ±
                mcToken.transfer(current, rewardAmount);
                userInfo[current].totalRevenue += rewardAmount;

                emit DifferentialRewardPaid(current, buyer, rewardAmount, currentLevel);
            }

            // æ›´æ–°ä¸ºå½“å‰ç­‰çº§ï¼Œç”¨äºä¸‹ä¸€å±‚æ¯”è¾ƒ
            previousLevel = currentLevel;
        }

        // ç§»åŠ¨åˆ°ä¸Šä¸€çº§æ¨èäºº
        current = userInfo[current].referrer;
    }
}
```

#### D. åœ¨è´­ä¹°é—¨ç¥¨æ—¶è°ƒç”¨

```solidity
function buyTicket(uint256 amount) external nonReentrant {
    // ... ç°æœ‰é€»è¾‘

    // 1. ç›´æ¨å¥–åŠ± (25%)
    if (referrerAddr != address(0)) {
        uint256 directReward = (amount * 25) / 100;
        mcToken.transfer(referrerAddr, directReward);
    }

    // 2. æå·®å¥–åŠ± (5%-45%)
    _distributeDifferentialRewards(msg.sender, amount);

    // 3. å±‚çº§å¥– (å¾…å®ç°)
    // _distributeLayerRewards(msg.sender, amount);

    // ... å…¶ä»–é€»è¾‘
}
```

### 3. äº‹ä»¶å®šä¹‰

```solidity
event DifferentialRewardPaid(
    address indexed receiver,
    address indexed buyer,
    uint256 amount,
    uint8 level
);
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1ï¼šåŸºæœ¬æå·®è®¡ç®—

```javascript
it("åº”è¯¥æ­£ç¡®è®¡ç®—å•å±‚æå·®å¥–åŠ±", async function () {
    // è®¾ç½®ï¼šV1æ¨èV0
    // V1æœ‰10ä¸ªæœ‰æ•ˆåœ°å€ï¼ŒV0è´­ä¹°é—¨ç¥¨

    // é¢„æœŸï¼šV1è·å¾—5%æå·®å¥–åŠ±
    const ticketAmount = ethers.parseEther("100");
    const expectedReward = ethers.parseEther("5"); // 5%

    // ... æµ‹è¯•ä»£ç 
});
```

### æµ‹è¯•2ï¼šå¹³çº§ä¸å‘æ”¾å¥–åŠ±

```javascript
it("å¹³çº§æ—¶ä¸åº”å‘æ”¾æå·®å¥–åŠ±", async function () {
    // è®¾ç½®ï¼šV2æ¨èV2
    // ä¸¤ä¸ªç”¨æˆ·éƒ½æ˜¯V2ç­‰çº§

    // é¢„æœŸï¼šä¸Šçº§V2ä¸è·å¾—æå·®å¥–åŠ±

    // ... æµ‹è¯•ä»£ç 
});
```

### æµ‹è¯•3ï¼šå¤šå±‚çº§æå·®åˆ†é…

```javascript
it("åº”è¯¥æ­£ç¡®åˆ†é…å¤šå±‚çº§æå·®å¥–åŠ±", async function () {
    // è®¾ç½®ï¼šV5 -> V3 -> V1 -> V0(è´­ä¹°è€…)

    // é¢„æœŸï¼š
    // V1è·å¾—: 5% - 0% = 5%
    // V3è·å¾—: 15% - 5% = 10%
    // V5è·å¾—: 25% - 15% = 10%

    // ... æµ‹è¯•ä»£ç 
});
```

### æµ‹è¯•4ï¼šæ”¶ç›Šä¸Šé™é™åˆ¶

```javascript
it("è¾¾åˆ°æ”¶ç›Šä¸Šé™åä¸åº”ç»§ç»­å‘æ”¾æå·®å¥–åŠ±", async function () {
    // è®¾ç½®ï¼šç”¨æˆ·å·²æ¥è¿‘3å€æ”¶ç›Šä¸Šé™

    // é¢„æœŸï¼šåªå‘æ”¾åˆ°ä¸Šé™ä¸ºæ­¢ï¼Œè¶…å‡ºéƒ¨åˆ†ä¸å‘æ”¾

    // ... æµ‹è¯•ä»£ç 
});
```

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. æå·®å¥–åŠ±çš„è®¡ç®—åŸºæ•°

**é—®é¢˜**ï¼šæå·®å¥–åŠ±åº”è¯¥åŸºäºä»€ä¹ˆé‡‘é¢è®¡ç®—ï¼Ÿ

**é€‰é¡¹A**ï¼šåŸºäºé—¨ç¥¨åŸå§‹é‡‘é¢ï¼ˆ100 MCï¼‰
```
ç›´æ¨å¥–åŠ±: 25%
æå·®å¥–åŠ±: åŸºäº100%åŸå§‹é‡‘é¢
æ€»è®¡å¯è¶…è¿‡100%
```

**é€‰é¡¹B**ï¼šåŸºäºå‰©ä½™é‡‘é¢ï¼ˆæ‰£é™¤ç›´æ¨åï¼‰
```
ç›´æ¨å¥–åŠ±: 25% (25 MC)
æå·®å¥–åŠ±: åŸºäºå‰©ä½™75 MC
```

**å»ºè®®**ï¼šé‡‡ç”¨**é€‰é¡¹A**ï¼ˆåŸºäºåŸå§‹é‡‘é¢ï¼‰ï¼Œå› ä¸ºï¼š
1. æ›´ç¬¦åˆä¼ ç»ŸMLMé€»è¾‘
2. ç™½çš®ä¹¦ä¸­å„é¡¹å¥–åŠ±æ¯”ä¾‹ç›¸åŠ è¶…è¿‡100%
3. åˆçº¦éœ€è¦é¢„å…ˆæ³¨å…¥è¶³å¤Ÿçš„MCä½œä¸ºå¥–åŠ±æ± 

### 2. å¥–åŠ±èµ„é‡‘æ¥æº

æå·®å¥–åŠ±çš„MCä»å“ªé‡Œæ¥ï¼Ÿ

**é€‰é¡¹A**ï¼šä»é—¨ç¥¨é‡‘é¢ä¸­æ‰£é™¤
```
é—®é¢˜ï¼šé—¨ç¥¨é‡‘é¢å¯èƒ½ä¸å¤Ÿåˆ†é…æ‰€æœ‰å¥–åŠ±
```

**é€‰é¡¹B**ï¼šä»å¥–åŠ±æ± ä¸­å‘æ”¾
```
âœ… æ¨èï¼šåˆçº¦é¢„å…ˆæ³¨å…¥MCä½œä¸ºå¥–åŠ±æ± 
ç±»ä¼¼ç°æœ‰çš„ claimRewards() é€»è¾‘
```

### 3. æ¨èå…³ç³»ç»‘å®š

**é—®é¢˜**ï¼šå¦‚ä½•é¿å…å¾ªç¯æ¨èï¼Ÿ

```solidity
function bindReferrer(address referrer) external {
    require(userInfo[msg.sender].referrer == address(0), "Already bound");
    require(referrer != msg.sender, "Cannot refer self");

    // âœ… æ·»åŠ ï¼šæ£€æŸ¥å¾ªç¯æ¨è
    require(!_isInReferralChain(referrer, msg.sender), "Circular referral");

    userInfo[msg.sender].referrer = referrer;
}

function _isInReferralChain(address user, address target) internal view returns (bool) {
    address current = user;
    for (uint i = 0; i < 20 && current != address(0); i++) {
        if (current == target) return true;
        current = userInfo[current].referrer;
    }
    return false;
}
```

---

## ğŸ“Œ å®æ–½æ­¥éª¤

### é˜¶æ®µ1ï¼šæ•°æ®ç»“æ„ï¼ˆ1å¤©ï¼‰
- [ ] æ·»åŠ  `level` å­—æ®µåˆ° `UserInfo`
- [ ] å®ç° `getLevel()` å‡½æ•°
- [ ] å®ç° `getLevelPercent()` å‡½æ•°

### é˜¶æ®µ2ï¼šæ ¸å¿ƒé€»è¾‘ï¼ˆ2å¤©ï¼‰
- [ ] å®ç° `_distributeDifferentialRewards()` å‡½æ•°
- [ ] åœ¨ `buyTicket()` ä¸­é›†æˆæå·®å¥–åŠ±
- [ ] æ·»åŠ äº‹ä»¶æ—¥å¿—

### é˜¶æ®µ3ï¼šæµ‹è¯•ï¼ˆ2å¤©ï¼‰
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] æµ‹è¯•å„ç§è¾¹ç•Œæƒ…å†µ
- [ ] æµ‹è¯•å¤šå±‚çº§åˆ†é…

### é˜¶æ®µ4ï¼šéƒ¨ç½²å’ŒéªŒè¯ï¼ˆ1å¤©ï¼‰
- [ ] éƒ¨ç½²åˆ°æµ‹è¯•ç½‘
- [ ] å‰ç«¯é›†æˆæ˜¾ç¤º
- [ ] ç”¨æˆ·æµ‹è¯•éªŒè¯

---

## ğŸ¯ FAQ

### Q1: å¦‚æœæ¨èé“¾ä¸­æœ‰äººç­‰çº§ç›¸åŒæ€ä¹ˆåŠï¼Ÿ

**A**: è·³è¿‡è¯¥å±‚ï¼Œä¸å‘æ”¾æå·®å¥–åŠ±ï¼Œç»§ç»­å‘ä¸ŠæŸ¥æ‰¾æ›´é«˜ç­‰çº§ã€‚

**ç¤ºä¾‹**ï¼š
```
V3 -> V2 -> V2 -> V1 -> V0(è´­ä¹°è€…)
              â†‘
           è·³è¿‡è¿™å±‚
```

å¥–åŠ±åˆ†é…ï¼š
- V1è·å¾—: 5% - 0% = 5%
- ç¬¬ä¸€ä¸ªV2è·å¾—: 10% - 5% = 5%
- ç¬¬äºŒä¸ªV2: è·³è¿‡ï¼ˆå¹³çº§ï¼‰
- V3è·å¾—: 15% - 10% = 5%

### Q2: æœ€å¤šèƒ½è·å¾—å¤šå°‘æå·®å¥–åŠ±ï¼Ÿ

**A**: ç†è®ºä¸Šï¼Œå¦‚æœä½ æ˜¯V9ï¼ˆ45%ï¼‰ï¼Œç›´æ¨æ˜¯V0ï¼ˆ0%ï¼‰ï¼Œä½ èƒ½è·å¾—45%çš„æå·®å¥–åŠ±ã€‚

ä½†å®é™…ä¸Šï¼Œå¥–åŠ±ä¼šè¢«ä¸­é—´å„å±‚åˆ†æ‘Šï¼š
```
V9(45%) -> V5(25%) -> V0
V5è·å¾—: 25%
V9è·å¾—: 45% - 25% = 20%
```

### Q3: æå·®å¥–åŠ±å’Œæ”¶ç›Šä¸Šé™çš„å…³ç³»ï¼Ÿ

**A**: æå·®å¥–åŠ±è®¡å…¥ `totalRevenue`ï¼Œå—3å€é—¨ç¥¨é‡‘é¢çš„æ”¶ç›Šä¸Šé™é™åˆ¶ã€‚

è¾¾åˆ°ä¸Šé™åï¼Œè¯¥ç”¨æˆ·ä¸å†è·å¾—ä»»ä½•æ”¶ç›Šï¼ˆåŒ…æ‹¬æå·®å¥–åŠ±ï¼‰ï¼Œéœ€è¦é‡æ–°è´­ä¹°é—¨ç¥¨æ¿€æ´»ã€‚

---

**æ›´æ–°æ—¶é—´**: 2025-12-18
**ç‰ˆæœ¬**: v1.0.0
**çŠ¶æ€**: è®¾è®¡æ–‡æ¡£
