name: Daily Token Burn

on:
  schedule:
    # æ¯æ—¥UTC 00:00æ‰§è¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_burn:
        description: 'å¼ºåˆ¶æ‰§è¡Œç‡ƒçƒ§ (å¿½ç•¥ä½™é¢æ£€æŸ¥)'
        required: false
        default: 'false'
        type: boolean

jobs:
  burn:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ðŸ”¥ Execute Daily Token Burn
      id: burn
      run: |
        echo "ðŸš€ å¼€å§‹æ‰§è¡Œæ¯æ—¥ä»£å¸ç‡ƒçƒ§ä»»åŠ¡..."
        echo "â° æ‰§è¡Œæ—¶é—´: $(date -u)"
        echo "ðŸŒ APIåœ°å€: ${{ secrets.BURN_API_URL }}"
        
        # æž„å»ºAPIè¯·æ±‚
        API_URL="${{ secrets.BURN_API_URL }}/api/burn"
        
        # è®¾ç½®è¯·æ±‚å¤´
        HEADERS="-H 'Content-Type: application/json'"
        if [ -n "${{ secrets.API_SECRET }}" ]; then
          HEADERS="$HEADERS -H 'Authorization: Bearer ${{ secrets.API_SECRET }}'"
        fi
        
        # æ‰§è¡Œç‡ƒçƒ§è¯·æ±‚
        echo "ðŸ“¡ å‘é€ç‡ƒçƒ§è¯·æ±‚..."
        response=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST $HEADERS "$API_URL")
        
        # è§£æžå“åº”
        http_code=$(echo "$response" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
        body=$(echo "$response" | sed -E 's/HTTPSTATUS:[0-9]*$//')
        
        echo "ðŸ“Š HTTPçŠ¶æ€ç : $http_code"
        echo "ðŸ“„ å“åº”å†…å®¹: $body"
        
        # ä¿å­˜å“åº”åˆ°è¾“å‡º
        echo "response_body=$body" >> $GITHUB_OUTPUT
        echo "http_code=$http_code" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ‰§è¡Œç»“æžœ
        if [ "$http_code" -eq 200 ]; then
          echo "âœ… ç‡ƒçƒ§APIè°ƒç”¨æˆåŠŸ"
          
          # è§£æžå“åº”JSON (ç®€å•æ£€æŸ¥)
          if echo "$body" | grep -q '"success":true'; then
            echo "âœ… ç‡ƒçƒ§ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
            
            # æå–ç‡ƒçƒ§ä¿¡æ¯
            if echo "$body" | grep -q '"burned":true'; then
              amount=$(echo "$body" | grep -o '"amount":"[^"]*"' | cut -d'"' -f4)
              txhash=$(echo "$body" | grep -o '"txHash":"[^"]*"' | cut -d'"' -f4)
              echo "ðŸ”¥ ç‡ƒçƒ§æ•°é‡: $amount JBC"
              echo "ðŸ“ äº¤æ˜“å“ˆå¸Œ: $txhash"
            else
              reason=$(echo "$body" | grep -o '"reason":"[^"]*"' | cut -d'"' -f4)
              echo "â„¹ï¸ æœ¬æ¬¡æ— éœ€ç‡ƒçƒ§: $reason"
            fi
          else
            echo "âŒ ç‡ƒçƒ§ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
            error=$(echo "$body" | grep -o '"error":"[^"]*"' | cut -d'"' -f4)
            echo "ðŸš¨ é”™è¯¯ä¿¡æ¯: $error"
            exit 1
          fi
        else
          echo "âŒ ç‡ƒçƒ§APIè°ƒç”¨å¤±è´¥ (HTTP $http_code)"
          exit 1
        fi

    - name: ðŸ“Š Query Burn Status
      if: success()
      run: |
        echo "ðŸ“Š æŸ¥è¯¢ç‡ƒçƒ§çŠ¶æ€..."
        
        status_response=$(curl -s "${{ secrets.BURN_API_URL }}/api/status")
        echo "ðŸ“„ çŠ¶æ€ä¿¡æ¯: $status_response"
        
        # æå–å…³é”®ä¿¡æ¯
        if echo "$status_response" | grep -q '"success":true'; then
          wallet_balance=$(echo "$status_response" | grep -o '"walletBalance":"[^"]*"' | cut -d'"' -f4)
          total_supply=$(echo "$status_response" | grep -o '"totalSupply":"[^"]*"' | cut -d'"' -f4)
          echo "ðŸ’° é’±åŒ…ä½™é¢: $wallet_balance JBC"
          echo "ðŸ“ˆ æ€»ä¾›åº”é‡: $total_supply JBC"
        fi

    - name: ðŸ” Health Check
      if: always()
      run: |
        echo "ðŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        
        health_response=$(curl -s "${{ secrets.BURN_API_URL }}/api/health")
        echo "â¤ï¸ å¥åº·çŠ¶æ€: $health_response"

    - name: ðŸ“¢ Send Success Notification
      if: success()
      run: |
        if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
          echo "ðŸ“¢ å‘é€æˆåŠŸé€šçŸ¥åˆ°Telegram..."
          
          message="ðŸ¤– GitHub Actions ç‡ƒçƒ§ä»»åŠ¡æŠ¥å‘Š%0A%0Aâœ… æ‰§è¡ŒçŠ¶æ€: æˆåŠŸ%0Aâ° æ‰§è¡Œæ—¶é—´: $(date -u)%0AðŸ”— å·¥ä½œæµ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$message" \
            -d "parse_mode=HTML"
          
          echo "âœ… Telegramé€šçŸ¥å‘é€å®Œæˆ"
        else
          echo "âš ï¸ Telegramé…ç½®æœªè®¾ç½®ï¼Œè·³è¿‡é€šçŸ¥"
        fi

    - name: ðŸš¨ Send Failure Notification
      if: failure()
      run: |
        if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
          echo "ðŸš¨ å‘é€å¤±è´¥é€šçŸ¥åˆ°Telegram..."
          
          message="ðŸ¤– GitHub Actions ç‡ƒçƒ§ä»»åŠ¡æŠ¥å‘Š%0A%0AâŒ æ‰§è¡ŒçŠ¶æ€: å¤±è´¥%0Aâ° æ‰§è¡Œæ—¶é—´: $(date -u)%0AðŸ”— å·¥ä½œæµ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}%0A%0Aè¯·æ£€æŸ¥æ—¥å¿—å¹¶æ‰‹åŠ¨å¤„ç†"
          
          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$message" \
            -d "parse_mode=HTML"
          
          echo "âœ… å¤±è´¥é€šçŸ¥å‘é€å®Œæˆ"
        else
          echo "âš ï¸ Telegramé…ç½®æœªè®¾ç½®ï¼Œè·³è¿‡é€šçŸ¥"
        fi

  # å¯é€‰: å¤‡ä»½ä»»åŠ¡çŠ¶æ€åˆ°Issue
  create-report:
    needs: burn
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“ Create Burn Report Issue
      if: github.event_name == 'schedule' # åªåœ¨å®šæ—¶ä»»åŠ¡æ—¶åˆ›å»ºæŠ¥å‘Š
      uses: actions/github-script@v7
      with:
        script: |
          const date = new Date().toISOString().split('T')[0];
          const status = '${{ needs.burn.result }}';
          const title = `Daily Burn Report - ${date}`;
          
          const body = `
          ## ðŸ“Š æ¯æ—¥ç‡ƒçƒ§æŠ¥å‘Š - ${date}
          
          **æ‰§è¡ŒçŠ¶æ€:** ${status === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}
          **æ‰§è¡Œæ—¶é—´:** ${new Date().toISOString()}
          **å·¥ä½œæµé“¾æŽ¥:** [æŸ¥çœ‹è¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### è¯¦ç»†ä¿¡æ¯
          - APIåœ°å€: ${{ secrets.BURN_API_URL }}
          - æ‰§è¡Œæ–¹å¼: GitHub Actions å®šæ—¶ä»»åŠ¡
          - ä¸‹æ¬¡æ‰§è¡Œ: æ˜Žæ—¥ UTC 00:00
          
          ${status === 'failure' ? 'âš ï¸ **éœ€è¦äººå·¥æ£€æŸ¥å’Œå¤„ç†**' : ''}
          `;
          
          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ä»Šæ—¥æŠ¥å‘Š
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['daily-burn-report'],
            state: 'open'
          });
          
          const existingIssue = issues.data.find(issue => issue.title === title);
          
          if (existingIssue) {
            // æ›´æ–°çŽ°æœ‰Issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: body
            });
          } else {
            // åˆ›å»ºæ–°Issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['daily-burn-report', status === 'success' ? 'success' : 'failure']
            });
          }