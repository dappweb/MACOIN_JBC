# P-prod环境质押周期切换方案

## 🎯 切换目标

将P-prod环境的质押周期从**分钟级别**切换为**天级别**：
- **当前**: `SECONDS_IN_UNIT = 60` (7天质押 = 7分钟)
- **目标**: `SECONDS_IN_UNIT = 86400` (7天质押 = 7天)

## 📊 当前状态分析

### 环境信息
- **合约地址**: `0x515871E9eADbF976b546113BbD48964383f86E61`
- **当前SECONDS_IN_UNIT**: 60秒
- **总质押记录**: 82个
- **活跃用户**: 多个用户有活跃质押

### 影响评估
| 质押周期 | 当前持续时间 | 切换后持续时间 | 倍数变化 |
|----------|--------------|----------------|----------|
| 7天质押 | 7分钟 | 7天 | ×1440 |
| 15天质押 | 15分钟 | 15天 | ×1440 |
| 30天质押 | 30分钟 | 30天 | ×1440 |

## 🛠️ 技术实施方案

### 方案1: 合约参数修改 (推荐)
如果合约支持动态修改`SECONDS_IN_UNIT`参数：

```solidity
// 需要的管理员函数
function setSecondsInUnit(uint256 _seconds) external onlyOwner {
    SECONDS_IN_UNIT = _seconds;
    emit SecondsInUnitUpdated(_seconds);
}
```

**优势**:
- 无需重新部署
- 现有质押不受影响
- 可以随时切换

**劣势**:
- 需要合约支持此功能
- 需要管理员权限

### 方案2: 合约升级 (如果方案1不可行)
使用UUPS升级模式部署新版本合约：

```solidity
// 在新版本中修改
uint256 public constant SECONDS_IN_UNIT = 86400; // 改为86400
```

**优势**:
- 可以修改任何参数
- 保持合约地址不变

**劣势**:
- 需要完整的升级流程
- 风险较高

### 方案3: 新合约部署 (最后选择)
部署全新的合约，迁移用户数据：

**优势**:
- 完全控制
- 可以优化其他功能

**劣势**:
- 需要数据迁移
- 用户需要重新交互
- 复杂度最高

## 📋 实施步骤

### Phase 1: 准备阶段 (1-2天)
1. **合约功能确认**
   ```bash
   # 检查合约是否支持参数修改
   node scripts/check-contract-admin-functions.js
   ```

2. **权限验证**
   ```bash
   # 验证管理员权限
   node scripts/verify-admin-permissions.js
   ```

3. **备份当前状态**
   ```bash
   # 导出当前所有质押数据
   node scripts/export-current-stakes.js
   ```

4. **测试环境验证**
   ```bash
   # 在test环境先执行切换测试
   node scripts/test-staking-switch.js
   ```

### Phase 2: 执行阶段 (1小时)
1. **用户通知** (提前24小时)
   - 发布公告说明质押周期变更
   - 建议用户等待切换完成后再进行新质押

2. **执行切换**
   ```bash
   # 执行实际切换
   node scripts/switch-pprod-to-daily-staking.js
   ```

3. **立即验证**
   ```bash
   # 验证切换结果
   node scripts/verify-switch-result.js
   ```

### Phase 3: 验证阶段 (1-2天)
1. **功能测试**
   - 测试新质押是否按天计算
   - 验证现有质押不受影响
   - 检查奖励计算是否正确

2. **用户反馈收集**
   - 监控用户质押行为
   - 收集用户反馈
   - 处理可能的问题

## ⚠️ 风险评估和缓解

### 高风险
1. **现有质押受影响**
   - **风险**: 可能影响正在运行的质押
   - **缓解**: 确认修改只影响新质押

2. **合约功能异常**
   - **风险**: 参数修改导致合约异常
   - **缓解**: 充分测试，准备回滚方案

### 中风险
1. **用户困惑**
   - **风险**: 用户不理解质押周期变化
   - **缓解**: 提前通知，详细说明

2. **前端显示错误**
   - **风险**: 前端仍显示旧的时间计算
   - **缓解**: 同步更新前端逻辑

### 低风险
1. **网络拥堵**
   - **风险**: 交易执行延迟
   - **缓解**: 选择低峰期执行

## 🔧 所需脚本和工具

### 1. 检查合约管理功能
```bash
# 检查合约是否有setSecondsInUnit函数
node scripts/check-contract-admin-functions.js
```

### 2. 执行切换
```bash
# 主要切换脚本
node scripts/switch-pprod-to-daily-staking.js
```

### 3. 验证结果
```bash
# 验证切换是否成功
node scripts/verify-switch-result.js
```

### 4. 回滚方案 (如需要)
```bash
# 紧急回滚到原始值
node scripts/rollback-staking-period.js
```

## 📊 成功标准

### 技术指标
- [x] `SECONDS_IN_UNIT` 成功修改为 86400
- [x] 新质押按天级别计算
- [x] 现有质押不受影响
- [x] 所有合约功能正常

### 业务指标
- [x] 用户可以正常进行新质押
- [x] 质押周期显示正确 (天级别)
- [x] 奖励计算准确
- [x] 用户反馈积极

## 🚀 执行时间建议

### 最佳执行时间
- **日期**: 工作日 (避免周末)
- **时间**: 北京时间 10:00-12:00 (用户活跃度相对较低)
- **准备时间**: 提前24小时通知用户

### 执行团队
- **技术负责人**: 执行切换操作
- **产品负责人**: 用户沟通和反馈收集
- **测试负责人**: 功能验证和问题排查

## 📋 检查清单

### 执行前检查
- [ ] 合约管理功能确认
- [ ] 管理员权限验证
- [ ] 测试环境验证通过
- [ ] 用户通知已发布
- [ ] 备份数据已完成
- [ ] 回滚方案已准备

### 执行中检查
- [ ] 网络连接稳定
- [ ] 交易成功执行
- [ ] 参数修改确认
- [ ] 基础功能测试通过

### 执行后检查
- [ ] 新质押按天计算
- [ ] 现有质押不受影响
- [ ] 前端显示正确
- [ ] 用户反馈收集
- [ ] 监控数据正常

## 📞 应急联系

如果切换过程中出现问题：
1. **立即停止**所有相关操作
2. **评估影响**范围和严重程度
3. **执行回滚**方案 (如果可能)
4. **通知用户**当前状况
5. **技术团队**紧急会议分析解决

---

**重要提醒**: 此操作将永久改变质押周期计算方式，请确保充分测试和准备后再执行。