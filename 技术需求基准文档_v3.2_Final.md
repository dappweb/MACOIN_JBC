# 金宝 RWA · DeFi 4.0 智能合约技术需求文档 v3.2 (Final)

## 一、项目概述
本项目构建一个基于 **双币强通缩模型** 的 DeFi 4.0 收益系统。
*   **MC (主结算代币)**：用于支付门票、为 AMM 提供流动性、结算主要收益。
*   **JBC (价值锚定代币)**：用于承载价值、燃烧通缩、结算部分静态收益。

核心逻辑：通过门票分流、强制为 AMM 提供流动性、高频销毁（买卖+底池）、动静态混合结算及强制出局机制，实现系统内循环。

---

## 二、核心代币定义

### 2.1 MC (Master Coin)
*   **类型**：原生代币 / ERC20（依链而定）。
*   **不可变性**：不可增发，不可冻结。
*   **用途**：
    1.  购买门票 (100%)。
    2.  为 AMM 提供流动性 (1.5倍门票额)。
    3.  静态收益结算 (50%)。
    4.  动态收益结算 (100%)。
    5.  赎回手续费 (1%)。

### 2.2 JBC (Jinbao Coin)
*   **类型**：ERC20。
*   **总量**：100,000,000 (1亿) 固定，不可增发。
*   **初始价格**：1 MC。
*   **用途**：
    1.  静态收益结算 (50%)。
    2.  AMM 交易对资产。
*   **通缩特性**：
    1.  买入滑点 50%（50% 到用户，50% 销毁）。
    2.  卖出滑点 25%（25% 销毁，75% 兑换）。
    3.  每日底池自动销毁 1%。

---

## 三、门票系统 (Ticket System)

### 3.1 门票档位
用户可购买多张门票，档位固定为：
*   **T1**: 100 MC
*   **T2**: 300 MC
*   **T3**: 500 MC
*   **T4**: 1000 MC

### 3.2 购买与激活 (核心风控)
1.  **购买**：用户支付对应 MC。
2.  **状态**：初始状态为 `Pending` (待提供流动性)。
3.  **激活时效**：用户必须在 **72小时** 内完成流动性提供操作。
    *   **超时处理**：门票自动作废 (Expired)，资金不退。
4.  **流动性要求**：必须提供门票金额 **1.5倍** 的 MC 作为流动性。
    *   例：买 1000 MC 门票，需再提供 1500 MC 用于注入 AMM 流动性池。

### 3.3 门票资金分配 (Tokenomics)
门票收入 (100% MC) 实时分配如下：
1.  **25% 直推奖励**：直接转给推荐人（需校验推荐人活跃状态）。
2.  **15% 极差/层级奖励**：
    *   进入**奖励池合约**。
    *   **结算规则**：详见 [五、动态收益体系](#五动态收益体系-dynamic-rewards)。
3.  **5% 市场基金**：转至项目方钱包。
4.  **5% 即时回购**：
    *   合约自动调用 DEX 接口，将 MC 换成 JBC。
    *   换得的 JBC **100% 直接销毁**。
5.  **25% 底池缓冲**：
    *   进入**缓冲合约**。
    *   **执行逻辑**：当缓冲池余额 > 阈值时，通过外部触发（如每笔交易附带或 Keeper）分批买入 JBC 并注入 LP，防止瞬时拉盘。
6.  **25% 国库托底**：转至国库钱包。

---

## 四、流动性与静态收益 (Liquidity Provision & Yield)

### 4.1 提供流动性规则
*   **前提**：持有有效（未过期）门票。
*   **金额**：门票金额 * 1.5。
*   **周期与收益率**：
    *   **7 天**：日化 2.0%
    *   **15 天**：日化 2.5%
    *   **30 天**：日化 3.0%
*   **锁定**：周期内不可撤出流动性。
*   **复投奖励（退还手续费）**：
    *   若用户存在上一轮已赎回且支付过 1% 手续费的记录。
    *   在本次成功提供流动性后，系统自动**退还**上一轮支付的 1% 赎回手续费（MC）至用户钱包。

### 4.2 收益结算
*   **计算公式**：`收益 = 投入流动性本金 * 日化率 * 周期天数`
*   **发放结构**：
    *   **50% MC**：直接发放。
    *   **50% JBC**：按**当前 AMM 价格**折算为 JBC 发放。

---

## 五、动态收益体系 (Dynamic Rewards)

### 5.1 奖励类型概览
所有动态奖励均以 **MC** 结算。

| 类型 | 比例 | 来源 | 发放时机 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **直推奖** | 25% | 门票收入 | 购买门票时秒结 | 直达上级钱包 |
| **极差奖** | 15% (Max 45%) | 门票收入/奖励池 | 下级赎回本金时 | 延迟满足，需完成流动性周期 |

### 5.2 极差奖励机制 (Differential Reward)

#### A. 等级定义 (V-Levels)
基于**有效直推人数**（Active Directs）进行升级：

| 等级 | 有效直推数 | 极差比例 |
| :--- | :--- | :--- |
| V0 | 0 | 0% |
| V1 | 10 | 5% |
| V2 | 30 | 10% |
| V3 | 100 | 15% |
| V4 | 300 | 20% |
| V5 | 1000 | 25% |
| V6 | 3000 | 30% |
| V7 | 10000 | 35% |
| V8 | 30000 | 40% |
| V9 | 100000 | 45% |

#### B. 计算与发放逻辑 (逐层向上)
1.  **计算时机**：当下级用户**购买门票**时。
2.  **计算基数**：下级用户的**门票金额**。
3.  **状态管理**：
    *   初始状态记录为 `Pending`（冻结）。
    *   **解锁条件**：当下级用户完成流动性周期并成功发起**赎回**操作时，状态变更为 `Released` 并发放。
4.  **算法**：
    *   从直推上级开始向上遍历。
    *   记录 `previousLevel`（初始为下级用户的等级或0）。
    *   若 `currentLevel > previousLevel`：
        *   `奖励比例 = currentPercent - previousPercent`
        *   `奖励金额 = 门票金额 * 奖励比例`
        *   记录/发放奖励。
        *   更新 `previousLevel = currentLevel`。
    *   若 `currentLevel <= previousLevel`（平级或低级）：
        *   **不发放奖励**（平级无收益）。
        *   继续向上寻找更高等级。
    *   直到遍历完 20 层或比例达到 45%（V9）。

### 5.3 出局机制 (3x Cap)
*   **3倍出局**：
    *   单张门票的 `(已领静态 + 已领动态)` >= `门票金额 * 3`。
    *   触发后，该门票状态设为 `EXITED`。
    *   **后果**：该门票对应的流动性本金强制赎回（扣除1%），不再产生静态收益；**该用户不再享受任何动态奖励**（直到购买新门票）。

---

## 六、交易与销毁 (AMM & Burn)

### 6.1 买入 JBC
*   用户支付 MC。
*   **滑点 50%**：
    *   50% JBC -> 用户。
    *   50% JBC -> **黑洞 (0x00...dead)**。

### 6.2 卖出 JBC
*   用户支付 JBC。
*   **滑点 25%**：
    *   25% JBC -> **黑洞**。
    *   75% JBC -> 兑换为 MC 给用户。

### 6.3 底池自动销毁 (Daily Burn)
*   **机制**：每日 00:00 UTC。
*   **操作**：移除 LP 中 **1% 的 JBC 数量**。
*   **去向**：直接销毁。
*   **实现**：`dailyBurn()` 函数，需开放给 Keeper 或任意用户调用（可设置调用奖励以激励执行）。

---

## 七、赎回机制 (Redemption)

1.  **条件**：流动性提供周期结束。
2.  **操作**：用户发起 `redeem()`。
3.  **费用**：扣除 **门票金额 1%** 的 MC 作为手续费。
    *   *注：此费用会在用户下一次提供流动性时退还。*
4.  **返还**：
    *   退回：100% 流动性本金 (MC)。
    *   发放：累计的静态收益 (50% MC + 50% JBC)。
    *   **触发**：解锁并释放对应的极差奖励（Pending -> Released）。

---

## 八、安全与权限

1.  **LP 权限**：初始添加流动性后，LP Token 必须打入黑洞或合约锁定，确保无法撤池。
2.  **参数限制**：所有费率（如滑点、日化）需设置硬顶（如不超过 50%），防止管理员恶意修改。
3.  **资金安全**：合约内沉淀的 MC（除国库/市场部分外）属于用户兑付准备金，管理员不可提取。
