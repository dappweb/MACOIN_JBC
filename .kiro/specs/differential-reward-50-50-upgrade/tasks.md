# 級差獎勵 50% MC + 50% JBC 分配機制升級實施計劃

## 概述

將現有的純 MC 級差獎勵機制升級為 50% MC + 50% JBC 分配機制，實現與靜態獎勵一致的雙代幣分配模式。

## 任務

- [ ] 1. 智能合約核心功能實施
- [x] 1.1 實施 50/50 分配引擎
  - 創建 `_distributeReward` 函數，實現 50% MC + 50% JBC 分配邏輯
  - 實現 JBC 數量計算: `jbcAmount = (totalAmount / 2) / jbcPrice`
  - 添加余額檢查和部分轉賬處理邏輯
  - _需求: 1.1, 1.2, 1.3, 1.5_

- [ ]* 1.2 編寫分配引擎屬性測試
  - **屬性 1: 50/50 分配守恆性**
  - **驗證需求: 1.1, 1.2**

- [x] 1.3 實施 JBC 價格計算模組
  - 實現 `getCurrentJBCPrice()` 函數
  - 使用公式: `(swapReserveMC * 1e18) / swapReserveJBC`
  - 添加流動性不足時的默認價格處理 (1:1 比例)
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [ ]* 1.4 編寫價格計算屬性測試
  - **屬性 3: 價格計算一致性**
  - **驗證需求: 2.1, 2.5**

- [ ] 1.5 更新級差獎勵時間機制
  - 修改質押創建時的級差計算和存儲邏輯
  - 更新質押到期時的獎勵釋放邏輯，使用實時 JBC 價格
  - 確保價格時點的正確性（釋放時計算）
  - _需求: 3.1, 3.2, 3.3_

- [ ]* 1.6 編寫時間機制屬性測試
  - **屬性 5: 時間機制正確性**
  - **驗證需求: 3.1, 3.2, 3.3**

- [ ] 2. 安全機制和錯誤處理
- [x] 2.1 實施余額檢查和安全轉賬
  - 添加 MC 和 JBC 余額檢查邏輯
  - 實現部分轉賬處理（余額不足時）
  - 添加轉賬失敗的錯誤處理和恢復機制
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ]* 2.2 編寫余額檢查屬性測試
  - **屬性 6: 余額檢查安全性**
  - **驗證需求: 4.1, 4.2, 4.3, 4.4, 4.5**

- [x] 2.3 實施流動性保護機制
  - 添加最小流動性閾值檢查
  - 實現價格異常保護邏輯
  - 添加大額分配時的影響監控
  - _需求: 2.4, 8.2, 8.4_

- [ ]* 2.4 編寫安全機制邊界測試
  - 測試極端價格情況和流動性不足場景
  - 驗證保護機制的觸發條件

- [ ] 3. 事件系統和日誌更新
- [ ] 3.1 更新事件定義和觸發邏輯
  - 添加 `DifferentialRewardReleased` 事件
  - 更新 `ReferralRewardPaid` 事件，包含 mcAmount 和 jbcAmount
  - 確保事件參數的完整性和準確性
  - _需求: 3.4, 5.1, 5.2, 5.3_

- [ ]* 3.2 編寫事件觸發屬性測試
  - **屬性 7: 事件觸發完整性**
  - **驗證需求: 3.4, 5.1, 5.3**

- [x] 3.3 增強日誌記錄系統
  - 添加 JBC 價格和計算詳情的日誌記錄
  - 實現分配失敗時的詳細錯誤日誌
  - 確保日誌信息的完整性和可追溯性
  - _需求: 3.5, 5.4, 5.5_

- [ ]* 3.4 編寫日誌記錄屬性測試
  - **屬性 8: 數據記錄準確性**
  - **驗證需求: 3.5, 5.4**

- [x] 4. 檢查點 - 確保核心功能正常運行
- 確保所有測試通過，如有問題請詢問用戶

- [ ] 5. 前端顯示適配
- [x] 5.1 更新級差獎勵顯示組件
  - 修改 `EarningsDetail.tsx` 中的級差獎勵顯示邏輯
  - 添加 "50% MC + 50% JBC 分配" 標識
  - 實現 MC 和 JBC 數量的分別顯示
  - _需求: 6.1, 6.2_

- [x] 5.2 實施價值計算和匯率顯示
  - 添加總價值計算和顯示功能
  - 實現 JBC 匯率信息的實時顯示
  - 確保價值計算的準確性
  - _需求: 6.3, 6.4_

- [ ]* 5.3 編寫前端顯示單元測試
  - 測試級差獎勵記錄的正確顯示
  - 驗證價值計算和匯率顯示的準確性

- [x] 5.4 添加級差獎勵特殊視覺標識
  - 設計和實現級差獎勵的特殊 UI 標識
  - 確保與其他獎勵類型的視覺區分
  - 優化移動端和桌面端的顯示效果
  - _需求: 6.5_

- [ ] 6. 向後兼容性和數據遷移
- [ ] 6.1 實施數據兼容性處理
  - 添加新舊記錄格式的識別邏輯
  - 實現歷史記錄的正確顯示和處理
  - 確保統計數據計算的準確性
  - _需求: 7.1, 7.2, 7.3, 7.4_

- [ ]* 6.2 編寫兼容性屬性測試
  - **屬性 9: 向後兼容性保持**
  - **驗證需求: 7.1, 7.2, 7.4**

- [ ] 6.3 實施平滑過渡機制
  - 設計和實現數據遷移策略
  - 添加遷移過程的監控和驗證
  - 確保遷移過程的安全性和可回滾性
  - _需求: 7.5_

- [ ]* 6.4 編寫數據遷移集成測試
  - 測試完整的數據遷移流程
  - 驗證遷移前後數據的一致性

- [ ] 7. 經濟安全性和監控
- [ ] 7.1 實施經濟安全約束
  - 添加 JBC 儲備限制檢查
  - 實現分配量的動態調整機制
  - 確保不超過合約儲備限制
  - _需求: 8.1_

- [ ]* 7.2 編寫經濟安全屬性測試
  - **屬性 10: 經濟安全性約束**
  - **驗證需求: 8.1**

- [ ] 7.3 實施監控和告警系統
  - 添加關鍵指標的監控邏輯
  - 實現異常情況的自動告警
  - 確保系統運行狀態的可觀測性
  - _需求: 10.1, 10.2, 10.3, 10.4_

- [ ] 8. 檢查點 - 確保所有功能完整性
- 確保所有測試通過，如有問題請詢問用戶

- [ ] 9. 集成測試和性能優化
- [ ] 9.1 執行端到端集成測試
  - 測試完整的級差獎勵分配流程
  - 驗證前端和後端的數據一致性
  - 確保各個組件的正確協作
  - _需求: 9.2_

- [ ]* 9.2 編寫性能測試
  - 測試大量分配操作的性能表現
  - 驗證系統在高負載下的穩定性

- [ ] 9.3 優化系統性能
  - 優化價格計算和分配邏輯的執行效率
  - 減少不必要的合約調用和計算
  - 提升用戶體驗和響應速度
  - _需求: 9.5_

- [ ] 10. 部署準備和文檔
- [ ] 10.1 準備部署腳本和配置
  - 創建合約升級部署腳本
  - 準備數據遷移腳本
  - 配置監控和告警系統

- [ ] 10.2 創建用戶文檔和教育材料
  - 編寫 50/50 分配機制的用戶指南
  - 創建常見問題解答 (FAQ)
  - 準備社區公告和說明材料

- [ ] 10.3 執行最終驗證測試
  - 在測試環境執行完整的升級流程
  - 驗證所有功能的正確性和穩定性
  - 確保部署準備的完整性

- [ ] 11. 最終檢查點 - 確保所有測試通過
- 確保所有測試通過，系統準備就緒，如有問題請詢問用戶

## 注意事項

- 標記為 `*` 的任務為可選測試任務，可根據開發進度決定是否實施
- 每個任務都包含具體的需求映射，確保實施的完整性
- 檢查點任務用於確保階段性目標的達成
- 屬性測試應運行最少 100 次迭代以確保可靠性
- 所有代幣轉賬操作都應包含適當的安全檢查
- 前端更新應保持與現有 UI 設計的一致性