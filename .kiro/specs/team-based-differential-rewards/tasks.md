# 基于团队总人数的极差奖励系统实现计划

## 概述

本实现计划将系统地改进极差奖励机制，从基于直接推荐人数改为基于团队总人数，包括合约升级、团队统计系统、新的层级配置和相关工具的开发。

## 任务

- [x] 1. 更新合约数据结构和配置
  - 添加团队统计相关的事件定义
  - 更新层级配置为基于团队人数的合理数值
  - 添加团队统计相关的错误类型
  - _需求: 2.1, 2.2_

- [ ]* 1.1 编写合约数据结构单元测试
  - 测试新增事件的正确触发
  - 测试层级配置的正确应用
  - _需求: 2.1_

- [x] 2. 实现团队统计核心功能
  - [x] 2.1 实现递归团队人数更新函数
    - 编写 `_updateTeamCountRecursive` 函数
    - 实现递归深度限制和性能保护
    - _需求: 1.1, 1.2, 4.1_

  - [ ]* 2.2 编写团队统计递归更新属性测试
    - **属性 2: 团队统计递归更新**
    - **验证: 需求 1.1, 1.2**

  - [x] 2.3 实现团队人数查询和验证函数
    - 编写 `getTeamCount` 和 `validateTeamCount` 函数
    - 实现团队统计一致性检查
    - _需求: 1.3, 6.2_

  - [ ]* 2.4 编写团队统计一致性属性测试
    - **属性 1: 团队统计一致性**
    - **验证: 需求 1.3**

- [x] 3. 修改用户状态更新逻辑
  - [x] 3.1 更新 `_updateActiveStatus` 函数
    - 集成团队人数的递归更新
    - 确保状态变更时正确更新所有上级的团队统计
    - _需求: 1.1, 1.2_

  - [ ]* 3.2 编写状态更新集成测试
    - 测试用户激活时的团队统计更新
    - 测试用户停用时的团队统计更新
    - _需求: 1.1, 1.2_

- [x] 4. 实现基于团队数的极差奖励计算
  - [x] 4.1 修改 `_calculateAndStoreDifferentialRewards` 函数
    - 将层级判定从 `activeDirects` 改为 `teamCount`
    - 实现基于团队人数的层级获取
    - _需求: 3.1, 3.2_

  - [ ]* 4.2 编写基于团队数的层级判定属性测试
    - **属性 3: 基于团队数的层级判定**
    - **验证: 需求 3.1**

  - [x] 4.3 实现新的层级配置查询函数
    - 编写 `getLevelByTeamCount` 函数
    - 确保与现有 `getLevel` 函数的兼容性
    - _需求: 3.2_

  - [ ]* 4.4 编写极差奖励差额计算属性测试
    - **属性 4: 极差奖励差额计算**
    - **验证: 需求 3.3**

  - [ ]* 4.5 编写奖励基数限制属性测试
    - **属性 5: 奖励基数限制**
    - **验证: 需求 3.4**

- [x] 5. 实现管理员工具和批量操作
  - [x] 5.1 实现批量团队统计更新功能
    - 编写 `batchUpdateTeamCounts` 函数
    - 实现批量操作的安全检查
    - _需求: 4.4, 5.4_

  - [x] 5.2 实现团队统计验证和修正工具
    - 编写 `recalculateTeamCount` 函数
    - 实现数据一致性验证工具
    - _需求: 6.2, 6.3_

  - [ ]* 5.3 编写管理员工具单元测试
    - 测试批量更新功能
    - 测试数据验证和修正功能
    - _需求: 4.4, 6.2_

- [x] 6. 实现性能优化和安全保护
  - [x] 6.1 添加递归深度和迭代次数限制
    - 实现防无限循环保护
    - 添加gas优化机制
    - _需求: 4.1, 4.2_

  - [ ]* 6.2 编写递归深度限制属性测试
    - **属性 6: 递归深度限制**
    - **验证: 需求 4.1**

  - [x] 6.3 实现优雅错误处理
    - 添加团队统计相关的错误处理
    - 确保部分失败时的数据一致性
    - _需求: 4.3_

  - [ ]* 6.4 编写错误处理单元测试
    - 测试各种错误情况的处理
    - 测试数据一致性保护
    - _需求: 4.3_

- [x] 7. 实现数据迁移和向后兼容
  - [x] 7.1 编写数据迁移脚本
    - 计算所有现有用户的团队人数
    - 实现安全的数据迁移流程
    - _需求: 5.2, 5.4_

  - [x] 7.2 确保向后兼容性
    - 保持现有层级奖励功能不变
    - 确保所有现有功能正常工作
    - _需求: 5.1, 5.3, 5.5_

  - [ ]* 7.3 编写向后兼容性属性测试
    - **属性 8: 向后兼容性**
    - **验证: 需求 5.3, 5.5**

- [x] 8. 实现查询和统计功能
  - [x] 8.1 实现团队详细信息查询
    - 编写团队层级分布查询功能
    - 实现用户团队详细信息查询
    - _需求: 6.1, 6.5_

  - [ ]* 8.2 编写查询功能单元测试
    - 测试团队信息查询的准确性
    - 测试统计功能的正确性
    - _需求: 6.1, 6.5_

- [x] 9. 合约编译和部署准备
  - [ ] 9.1 编译更新后的合约
    - 确保所有新功能正确编译
    - 解决任何编译错误或警告
    - _需求: 所有_

  - [ ] 9.2 准备升级脚本
    - 编写合约升级脚本
    - 准备数据迁移执行计划
    - _需求: 5.2, 5.4_

- [ ] 10. 综合测试和验证
  - [ ] 10.1 运行完整测试套件
    - 执行所有单元测试和属性测试
    - 验证所有功能的正确性
    - _需求: 所有_

  - [ ]* 10.2 编写事件触发一致性属性测试
    - **属性 9: 事件触发一致性**
    - **验证: 需求 1.5, 4.5**

  - [ ]* 10.3 编写数据修正有效性属性测试
    - **属性 10: 数据修正有效性**
    - **验证: 需求 6.3**

  - [ ]* 10.4 编写配置即时生效属性测试
    - **属性 7: 配置即时生效**
    - **验证: 需求 2.3**

- [ ] 11. 部署和迁移执行
  - [ ] 11.1 执行合约升级
    - 在测试网络上验证升级
    - 执行主网合约升级
    - _需求: 5.2_

  - [ ] 11.2 执行数据迁移
    - 运行团队统计初始化脚本
    - 验证迁移结果的准确性
    - _需求: 5.2, 5.4_

  - [ ] 11.3 验证系统功能
    - 测试所有功能在升级后的正常运行
    - 监控系统性能和稳定性
    - _需求: 5.5_

- [ ] 12. 最终验证和文档更新
  - 确保所有测试通过，系统稳定运行
  - 更新相关文档和用户指南
  - 完成功能验收和上线确认

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以根据开发进度决定是否实施
- 每个任务都引用了具体的需求，确保实现的可追溯性
- 属性测试必须包含对应的属性编号和验证的需求
- 所有涉及合约状态变更的功能都需要相应的事件记录
- 性能优化和安全保护是关键要求，不可忽视
- 向后兼容性必须得到保证，不能影响现有用户的使用