# 基于团队总人数的极差奖励系统需求文档

## 介绍

当前的极差奖励系统基于直接推荐人数（activeDirects）来判定用户层级，这导致层级门槛过高，大团队建设者无法获得应有的奖励。本需求旨在改进系统，使用团队总人数（teamCount）作为层级判定基础，更好地激励深度团队建设。

## 术语表

- **TeamCount**: 用户整个推荐网络中的活跃用户总数（包括所有下级层级）
- **ActiveDirects**: 用户直接推荐的活跃用户数量（仅一级下级）
- **DifferentialReward**: 基于层级差额计算的奖励机制
- **LevelConfig**: 层级配置，定义达到各层级所需的最小团队人数和奖励比例

## 需求

### 需求1：团队人数统计系统

**用户故事**: 作为系统管理员，我希望系统能够准确统计每个用户的团队总人数，以便基于团队规模进行层级判定。

#### 验收标准

1. WHEN 用户状态变为活跃时，THE 系统 SHALL 递归更新所有上级用户的团队人数
2. WHEN 用户状态变为非活跃时，THE 系统 SHALL 递归减少所有上级用户的团队人数
3. THE 系统 SHALL 维护每个用户的准确团队总人数统计
4. THE 系统 SHALL 防止团队统计过程中的无限循环
5. THE 系统 SHALL 在团队人数变化时触发相应事件

### 需求2：基于团队人数的层级配置

**用户故事**: 作为产品经理，我希望调整层级配置，使其基于合理的团队规模要求，让更多用户能够达到相应层级。

#### 验收标准

1. THE 系统 SHALL 使用以下团队人数要求的层级配置：
   - 9级：10,000人团队，45%奖励比例
   - 8级：5,000人团队，40%奖励比例
   - 7级：2,000人团队，35%奖励比例
   - 6级：1,000人团队，30%奖励比例
   - 5级：500人团队，25%奖励比例
   - 4级：200人团队，20%奖励比例
   - 3级：100人团队，15%奖励比例
   - 2级：50人团队，10%奖励比例
   - 1级：20人团队，5%奖励比例
2. THE 系统 SHALL 允许管理员更新层级配置
3. WHEN 层级配置更新时，THE 系统 SHALL 立即生效于新的奖励计算

### 需求3：基于团队人数的极差奖励计算

**用户故事**: 作为用户，我希望极差奖励基于团队总人数计算，这样我的团队建设努力能够得到更公平的回报。

#### 验收标准

1. WHEN 计算极差奖励时，THE 系统 SHALL 使用团队总人数而非直接推荐人数来判定层级
2. WHEN 遍历推荐关系链时，THE 系统 SHALL 基于每个上级的团队人数获取其层级奖励比例
3. WHEN 上级的层级比例大于前一级时，THE 系统 SHALL 计算层级差额奖励
4. THE 系统 SHALL 确保奖励基数不超过上级的门票金额
5. THE 系统 SHALL 将计算出的奖励存储为待发放状态

### 需求4：团队统计性能优化

**用户故事**: 作为系统架构师，我希望团队统计功能具有良好的性能，不会因为大型团队而导致交易失败。

#### 验收标准

1. THE 系统 SHALL 限制团队统计的递归深度不超过20层
2. THE 系统 SHALL 在单次交易中限制团队统计的迭代次数
3. WHEN 团队统计超过限制时，THE 系统 SHALL 优雅地处理而不是失败
4. THE 系统 SHALL 提供批量更新团队统计的管理员功能
5. THE 系统 SHALL 记录团队统计更新的相关事件

### 需求5：向后兼容性

**用户故事**: 作为现有用户，我希望系统升级不会影响我已有的数据和奖励。

#### 验收标准

1. THE 系统 SHALL 保留现有的activeDirects字段用于层级奖励计算
2. THE 系统 SHALL 在升级后正确初始化所有用户的团队人数
3. THE 系统 SHALL 确保现有的层级奖励机制不受影响
4. THE 系统 SHALL 提供管理员工具来修正升级后的团队统计数据
5. WHEN 系统升级时，THE 系统 SHALL 保持所有现有功能的正常运行

### 需求6：数据一致性验证

**用户故事**: 作为系统管理员，我希望能够验证团队统计数据的准确性，确保奖励计算的公正性。

#### 验收标准

1. THE 系统 SHALL 提供查询用户团队详细信息的功能
2. THE 系统 SHALL 提供验证团队统计准确性的管理员工具
3. THE 系统 SHALL 在团队统计不一致时提供修正机制
4. THE 系统 SHALL 记录所有团队统计变更的审计日志
5. THE 系统 SHALL 提供团队层级分布的统计查询功能