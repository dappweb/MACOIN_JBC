# 級差獎勵 50% MC + 50% JBC 分配機制升級需求文檔

## 介紹

將現有的純 MC 級差獎勵機制升級為 50% MC + 50% JBC 分配機制，與靜態獎勵保持一致，完善雙代幣經濟模型，提供更多樣化的收益方式。

## 術語表

- **級差獎勵**: 基於團隊層級差異的獎勵機制
- **50/50 分配**: 50% MC + 50% JBC (等值) 的獎勵分配方式
- **JBC_價格**: 基於 AMM 池計算的 JBC 對 MC 的實時匯率
- **AMM_池**: 自動做市商流動性池，用於 MC/JBC 交換
- **釋放時機**: 質押到期或退出時分配級差獎勵的時間點
- **價格時點**: 用於計算 JBC 數量的價格參考時間

## 需求

### 需求 1: 實施 50/50 分配機制

**用戶故事**: 作為用戶，我希望級差獎勵採用 50% MC + 50% JBC 的分配方式，以獲得多樣化的代幣收益。

#### 驗收標準

1. WHEN 分配級差獎勵 THEN 系統應將總額的 50% 分配為 MC
2. WHEN 分配級差獎勵 THEN 系統應將總額的 50% 按當前 JBC 價格轉換為 JBC 數量
3. WHEN 計算 JBC 數量 THEN 系統應使用公式: JBC數量 = (總額 ÷ 2) ÷ JBC價格
4. WHEN JBC 價格為 0 或流動性不足 THEN 系統應使用 1:1 默認比例
5. WHEN 分配完成 THEN 用戶應同時收到 MC 和 JBC 代幣

### 需求 2: JBC 價格計算機制

**用戶故事**: 作為系統，我需要準確計算 JBC 價格，確保 50/50 分配的價值等值性。

#### 驗收標準

1. WHEN 計算 JBC 價格 THEN 系統應使用公式: (swapReserveMC × 1e18) ÷ swapReserveJBC
2. WHEN AMM 池 MC 儲備為 0 THEN 系統應使用 1 ether 作為默認價格
3. WHEN AMM 池 JBC 儲備為 0 THEN 系統應使用 1 ether 作為默認價格
4. WHEN 流動性低於最小閾值 THEN 系統應啟用流動性保護機制
5. WHEN 價格計算完成 THEN 系統應記錄價格和時間戳

### 需求 3: 時間機制更新

**用戶故事**: 作為系統，我需要在正確的時機執行 50/50 分配，確保價格計算的準確性。

#### 驗收標準

1. WHEN 質押創建時 THEN 系統應計算並存儲級差總額 (MC 等值)
2. WHEN 質押到期或退出時 THEN 系統應獲取當前 JBC 價格執行分配
3. WHEN 執行分配時 THEN 系統應使用釋放時的實時 JBC 價格
4. WHEN 分配完成 THEN 系統應觸發 DifferentialRewardReleased 事件
5. WHEN 記錄獎勵 THEN 系統應分別記錄 MC 和 JBC 數量

### 需求 4: 安全機制和余額檢查

**用戶故事**: 作為系統，我需要確保分配過程的安全性，處理各種異常情況。

#### 驗收標準

1. WHEN 檢查 MC 余額 THEN 系統應確認合約有足夠的 MC 代幣
2. WHEN 檢查 JBC 余額 THEN 系統應確認合約有足夠的 JBC 代幣
3. WHEN MC 余額不足 THEN 系統應只轉賬可用的 MC，JBC 正常轉賬
4. WHEN JBC 余額不足 THEN 系統應只轉賬可用的 JBC，MC 正常轉賬
5. WHEN 兩種代幣都不足 THEN 系統應按可用余額比例分配

### 需求 5: 事件和日誌更新

**用戶故事**: 作為開發者，我需要詳細的事件日誌來追蹤 50/50 分配的執行情況。

#### 驗收標準

1. WHEN 級差獎勵釋放 THEN 系統應觸發 DifferentialRewardReleased 事件
2. WHEN 推薦獎勵支付 THEN 系統應觸發更新的 ReferralRewardPaid 事件
3. WHEN 事件觸發 THEN 系統應包含 mcAmount 和 jbcAmount 參數
4. WHEN 記錄日誌 THEN 系統應包含 JBC 價格和計算詳情
5. WHEN 分配失敗 THEN 系統應記錄詳細的錯誤信息

### 需求 6: 前端顯示適配

**用戶故事**: 作為用戶，我希望在前端清楚看到級差獎勵的 50/50 分配詳情。

#### 驗收標準

1. WHEN 顯示級差獎勵記錄 THEN 系統應分別顯示 MC 和 JBC 數量
2. WHEN 顯示獎勵詳情 THEN 系統應標明 "50% MC + 50% JBC 分配"
3. WHEN 顯示總價值 THEN 系統應計算並顯示等值的 MC 總價值
4. WHEN 顯示匯率信息 THEN 系統應顯示當時的 JBC 價格
5. WHEN 區分獎勵類型 THEN 級差獎勵應有特殊的視覺標識

### 需求 7: 向後兼容性

**用戶故事**: 作為系統管理員，我需要確保升級不會影響現有的級差獎勵記錄和功能。

#### 驗收標準

1. WHEN 系統升級後 THEN 現有的級差獎勵記錄應保持完整
2. WHEN 處理舊記錄 THEN 系統應正確識別純 MC 分配的歷史記錄
3. WHEN 顯示歷史記錄 THEN 系統應區分新舊分配機制
4. WHEN 計算統計數據 THEN 系統應正確處理新舊兩種格式
5. WHEN 數據遷移 THEN 系統應提供平滑的過渡機制

### 需求 8: 經濟影響控制

**用戶故事**: 作為協議管理者，我需要控制 50/50 分配對代幣經濟的影響。

#### 驗收標準

1. WHEN 分配 JBC THEN 系統應確保不超過合約的 JBC 儲備
2. WHEN JBC 價格異常 THEN 系統應啟用價格保護機制
3. WHEN 大量分配時 THEN 系統應監控對 AMM 池的影響
4. WHEN 流動性不足 THEN 系統應限制或延遲分配
5. WHEN 檢測異常 THEN 系統應觸發管理員告警

### 需求 9: 測試和驗證

**用戶故事**: 作為開發者，我需要全面的測試來確保 50/50 分配機制的正確性。

#### 驗收標準

1. WHEN 執行單元測試 THEN 所有分配計算函數應通過測試
2. WHEN 執行集成測試 THEN 完整的分配流程應正常工作
3. WHEN 執行屬性測試 THEN 分配守恆性應得到驗證
4. WHEN 測試邊界條件 THEN 極端情況應得到正確處理
5. WHEN 性能測試 THEN 分配操作應在可接受的時間內完成

### 需求 10: 監控和維護

**用戶故事**: 作為運維人員，我需要監控 50/50 分配機制的運行狀況。

#### 驗收標準

1. WHEN 監控分配 THEN 系統應記錄每次分配的詳細數據
2. WHEN 檢查余額 THEN 系統應定期驗證合約代幣余額
3. WHEN 價格異常 THEN 系統應發送告警通知
4. WHEN 分配失敗 THEN 系統應記錄失敗原因和恢復建議
5. WHEN 生成報告 THEN 系統應提供分配統計和分析數據