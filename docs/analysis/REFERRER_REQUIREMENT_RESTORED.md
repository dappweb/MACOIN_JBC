# æ¨èäººè¦æ±‚æ¢å¤åˆ†æ

## ğŸ“‹ æ”¹åŠ¨æ¦‚è¿°

æœ¬æ¬¡å‡çº§æ¢å¤äº†è´­ä¹°é—¨ç¥¨çš„æ¨èäººè¦æ±‚ã€‚ç”¨æˆ·å¿…é¡»å…ˆç»‘å®šæ¨èäººæ‰èƒ½è´­ä¹°é—¨ç¥¨ã€‚

## ğŸ”„ æ”¹åŠ¨è¯¦æƒ…

### ä¿®æ”¹å‰ï¼ˆå½“å‰ç‰ˆæœ¬ï¼‰

```solidity
function buyTicket() external payable nonReentrant whenNotPaused {
    uint256 amount = msg.value;
    _expireTicketIfNeeded(msg.sender);
    
    // æ²¡æœ‰æ¨èäººæ£€æŸ¥
    // å¦‚æœæ— æ¨èäººï¼Œç›´æ¨å¥–åŠ±ä¼šè½¬åˆ°è¥é”€é’±åŒ…
    // ...
}
```

**è¡Œä¸º**:
- âœ… å…è®¸æ— æ¨èäººè´­ä¹°é—¨ç¥¨
- âœ… å¦‚æœæ— æ¨èäººï¼Œç›´æ¨å¥–åŠ±ï¼ˆ25%ï¼‰è½¬åˆ°è¥é”€é’±åŒ…
- âœ… ç”¨æˆ·å¯ä»¥éšæ—¶è´­ä¹°é—¨ç¥¨

### ä¿®æ”¹åï¼ˆå‡çº§åï¼‰

```solidity
function buyTicket() external payable nonReentrant whenNotPaused {
    // æ£€æŸ¥æ˜¯å¦å·²ç»‘å®šæ¨èäºº
    if (userInfo[msg.sender].referrer == address(0)) {
        revert MustBindReferrer();
    }
    
    uint256 amount = msg.value;
    _expireTicketIfNeeded(msg.sender);
    // ...
}
```

**è¡Œä¸º**:
- âš ï¸ å¿…é¡»å…ˆç»‘å®šæ¨èäººæ‰èƒ½è´­ä¹°é—¨ç¥¨
- âš ï¸ æœªç»‘å®šæ¨èäººæ—¶è´­ä¹°ä¼šå¤±è´¥ï¼ˆæŠ›å‡º `MustBindReferrer()` é”™è¯¯ï¼‰
- âœ… ç»‘å®šæ¨èäººåå¯ä»¥æ­£å¸¸è´­ä¹°é—¨ç¥¨

## ğŸ†• æ–°å¢é”™è¯¯

```solidity
error MustBindReferrer();
```

å½“ç”¨æˆ·æœªç»‘å®šæ¨èäººæ—¶å°è¯•è´­ä¹°é—¨ç¥¨ï¼Œä¼šæŠ›å‡ºæ­¤é”™è¯¯ã€‚

## ğŸ“Š å½±å“åˆ†æ

### å¯¹ç°æœ‰ç”¨æˆ·çš„å½±å“

| ç”¨æˆ·ç±»å‹ | å½±å“ | è¯´æ˜ |
|---------|------|------|
| **å·²ç»‘å®šæ¨èäºº** | âœ… æ— å½±å“ | å¯ä»¥æ­£å¸¸è´­ä¹°é—¨ç¥¨ |
| **æœªç»‘å®šæ¨èäºº** | âš ï¸ æ— æ³•è´­ä¹° | éœ€è¦å…ˆè°ƒç”¨ `bindReferrer()` |

### å¯¹æ–°ç”¨æˆ·çš„å½±å“

1. **æ³¨å†Œæµç¨‹å˜åŒ–**:
   - ä¹‹å‰: å¯ä»¥ç›´æ¥è´­ä¹°é—¨ç¥¨ï¼ˆæ— æ¨èäººæ—¶å¥–åŠ±è½¬åˆ°è¥é”€é’±åŒ…ï¼‰
   - ç°åœ¨: å¿…é¡»å…ˆç»‘å®šæ¨èäººï¼Œç„¶åæ‰èƒ½è´­ä¹°é—¨ç¥¨

2. **æ¨èäººç»‘å®š**:
   - æ–°ç”¨æˆ·å¿…é¡»è°ƒç”¨ `bindReferrer(address referrer)` ç»‘å®šæ¨èäºº
   - ç»‘å®šåå¯ä»¥æ­£å¸¸è´­ä¹°é—¨ç¥¨

### å¯¹å‰ç«¯çš„å½±å“

å‰ç«¯éœ€è¦ï¼š
1. âœ… æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»‘å®šæ¨èäºº
2. âœ… å¦‚æœæœªç»‘å®šï¼Œæç¤ºç”¨æˆ·å…ˆç»‘å®šæ¨èäºº
3. âœ… æä¾›æ¨èäººç»‘å®šç•Œé¢
4. âœ… è´­ä¹°é—¨ç¥¨å‰éªŒè¯æ¨èäººçŠ¶æ€

## ğŸ” ä»£ç å˜æ›´

### åˆçº¦ä»£ç 

**æ–‡ä»¶**: `contracts/JinbaoProtocolNative.sol`

**å˜æ›´**:
1. æ–°å¢é”™è¯¯å®šä¹‰: `error MustBindReferrer();`
2. åœ¨ `buyTicket()` å‡½æ•°å¼€å¤´æ·»åŠ æ¨èäººæ£€æŸ¥

### å‰ç«¯ä»£ç 

å‰ç«¯éœ€è¦æ›´æ–°ï¼š
- è´­ä¹°é—¨ç¥¨å‰æ£€æŸ¥æ¨èäººçŠ¶æ€
- æ˜¾ç¤ºæ¨èäººç»‘å®šæç¤º
- å¤„ç† `MustBindReferrer()` é”™è¯¯

## âœ… éªŒè¯æ­¥éª¤

å‡çº§åéªŒè¯ï¼š

1. **æœªç»‘å®šæ¨èäººç”¨æˆ·**:
   ```javascript
   // åº”è¯¥å¤±è´¥
   await protocolContract.buyTicket({ value: ethers.parseEther("100") });
   // é¢„æœŸ: æŠ›å‡º MustBindReferrer() é”™è¯¯
   ```

2. **ç»‘å®šæ¨èäººå**:
   ```javascript
   // å…ˆç»‘å®šæ¨èäºº
   await protocolContract.bindReferrer(REFERRER_ADDRESS);
   
   // ç„¶åå¯ä»¥è´­ä¹°é—¨ç¥¨
   await protocolContract.buyTicket({ value: ethers.parseEther("100") });
   // é¢„æœŸ: æˆåŠŸ
   ```

## ğŸ“ ç›¸å…³å‡½æ•°

### bindReferrer()

```solidity
function bindReferrer(address referrer) external {
    // ç»‘å®šæ¨èäºº
    // åªèƒ½ç»‘å®šä¸€æ¬¡
    // ä¸èƒ½ç»‘å®šè‡ªå·±
    // ä¸èƒ½ç»‘å®šåœ°å€(0)
}
```

### buyTicket()

```solidity
function buyTicket() external payable {
    // ç°åœ¨éœ€è¦å…ˆæ£€æŸ¥æ¨èäºº
    if (userInfo[msg.sender].referrer == address(0)) {
        revert MustBindReferrer();
    }
    // ...
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç”¨æˆ·ä½“éªŒ**: 
   - æ–°ç”¨æˆ·å¿…é¡»å…ˆç»‘å®šæ¨èäººï¼Œå¯èƒ½å¢åŠ æ³¨å†Œé—¨æ§›
   - å»ºè®®å‰ç«¯æä¾›æ¸…æ™°çš„æ¨èäººç»‘å®šå¼•å¯¼

2. **æ¨èäººç³»ç»Ÿ**:
   - ç¡®ä¿æ¨èäººç³»ç»Ÿæ­£å¸¸å·¥ä½œ
   - æä¾›æ¨èäººæŸ¥æ‰¾/éªŒè¯åŠŸèƒ½

3. **é”™è¯¯å¤„ç†**:
   - å‰ç«¯éœ€è¦æ•è· `MustBindReferrer()` é”™è¯¯
   - æä¾›å‹å¥½çš„é”™è¯¯æç¤ºå’Œè§£å†³æ–¹æ¡ˆ

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å‡çº§æ€»ç»“](../UPGRADE_SUMMARY.md)
- [å‡çº§å˜åŒ–è¯¦æƒ…](./UPGRADE_CHANGES_DETAIL.md)
- [å‡çº§å®‰å…¨æ€§åˆ†æ](./UPGRADE_SAFETY_ANALYSIS.md)

---

**æ”¹åŠ¨ç±»å‹**: åŠŸèƒ½æ¢å¤  
**å½±å“èŒƒå›´**: æ‰€æœ‰ç”¨æˆ·ï¼ˆç‰¹åˆ«æ˜¯æ–°ç”¨æˆ·ï¼‰  
**å‡çº§ä¼˜å…ˆçº§**: é«˜ï¼ˆä¸å›è´­æœºåˆ¶æ›´æ–°ä¸€èµ·å‡çº§ï¼‰







