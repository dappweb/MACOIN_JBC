# Jinbao Protocol 业务逻辑需求规范

## 项目概述

**项目名称**: Jinbao Protocol DeFi 4.0 完整业务逻辑  
**项目类型**: 去中心化金融协议  
**代币架构**: 原生MC代币 + ERC20 JBC代币  
**核心功能**: 门票系统、流动性挖矿、AMM交换、多层奖励机制  

## 术语表

- **MC (Master Coin)**: 原生代币，类似于以太坊的ETH，无需授权直接使用
- **JBC (Jinbao Coin)**: ERC20代币，具有燃烧机制的通缩代币
- **门票 (Ticket)**: 用户参与系统的入场券，决定收益上限
- **质押 (Staking)**: 锁定MC代币获取静态收益的机制
- **AMM**: 自动做市商，提供MC/JBC代币交换服务
- **直推**: 直接推荐的下级用户
- **团队**: 推荐网络中的所有下级用户
- **极差奖励**: 基于团队等级差异的奖励机制
- **收益上限**: 用户最大可获得收益，为门票金额的3倍

## 需求分类

### 1. 门票系统需求

#### 需求 1.1: 门票购买功能
**用户故事**: 作为用户，我希望能够购买不同等级的门票，以便参与系统并获得相应的收益上限。

**验收标准**:
1. THE 系统 SHALL 支持四种门票等级：100 MC、300 MC、500 MC、1000 MC
2. WHEN 用户购买门票时，THE 系统 SHALL 使用原生MC代币进行支付
3. WHEN 门票购买成功时，THE 系统 SHALL 设置用户收益上限为门票金额的3倍
4. WHEN 用户已有门票时，THE 系统 SHALL 允许累加购买并相应增加收益上限
5. THE 系统 SHALL 记录用户的最大门票金额和最大单次门票金额

#### 需求 1.2: 门票过期机制
**用户故事**: 作为系统管理员，我希望门票有过期机制，以确保用户的活跃参与。

**验收标准**:
1. THE 系统 SHALL 设置门票灵活期为72小时
2. WHEN 用户无活跃质押且超过灵活期时，THE 系统 SHALL 自动过期门票
3. WHEN 门票过期时，THE 系统 SHALL 清空用户门票数据并设置为非活跃状态
4. THE 系统 SHALL 在门票过期时触发相应事件

#### 需求 1.3: 门票状态管理
**用户故事**: 作为用户，我希望了解我的门票状态和相关信息。

**验收标准**:
1. THE 系统 SHALL 为每个门票分配唯一ID
2. THE 系统 SHALL 记录门票购买时间、金额和退出状态
3. THE 系统 SHALL 提供查询用户门票信息的接口
4. WHEN 用户达到收益上限时，THE 系统 SHALL 自动标记门票为已退出状态

### 2. MC代币系统需求

#### 需求 2.1: 原生MC代币功能
**用户故事**: 作为用户，我希望使用原生MC代币进行各种操作，享受简化的交易体验。

**验收标准**:
1. THE 系统 SHALL 支持原生MC代币作为主要支付方式
2. THE 系统 SHALL 消除所有MC代币授权需求
3. WHEN 用户进行MC相关操作时，THE 系统 SHALL 使用payable函数直接接收
4. THE 系统 SHALL 提供安全的原生MC转账机制
5. THE 系统 SHALL 在原生MC转账失败时抛出相应错误

#### 需求 2.2: MC资金分配机制
**用户故事**: 作为系统设计者，我希望门票购买的MC资金能够合理分配到各个功能模块。

**验收标准**:
1. WHEN 用户购买门票时，THE 系统 SHALL 按以下比例分配MC资金：
   - 直推奖励：25%
   - 级差奖励：15%
   - 营销钱包：5%
   - 回购销毁：5%
   - 流动性注入：25%
   - 国库钱包：25%
2. THE 系统 SHALL 确保所有分配比例总和为100%
3. THE 系统 SHALL 允许管理员调整分配比例
4. THE 系统 SHALL 在资金分配时触发相应事件

#### 需求 2.3: MC余额管理
**用户故事**: 作为用户，我希望能够实时查看我的原生MC余额。

**验收标准**:
1. THE 系统 SHALL 提供查询用户原生MC余额的功能
2. THE 系统 SHALL 在交易后自动更新余额显示
3. THE 系统 SHALL 验证用户余额是否足够支付交易金额和Gas费用
4. THE 系统 SHALL 在余额不足时提供明确的错误提示

### 3. JBC代币系统需求

#### 需求 3.1: JBC代币基础功能
**用户故事**: 作为用户，我希望能够获得和使用JBC代币，参与系统的通缩机制。

**验收标准**:
1. THE 系统 SHALL 实现JBC作为ERC20代币
2. THE 系统 SHALL 支持JBC代币的铸造和燃烧功能
3. THE 系统 SHALL 限制JBC铸造权限仅给协议合约
4. THE 系统 SHALL 在奖励分配时铸造相应数量的JBC
5. THE 系统 SHALL 提供JBC代币余额查询功能

#### 需求 3.2: JBC获取机制
**用户故事**: 作为用户，我希望通过多种方式获得JBC代币。

**验收标准**:
1. THE 系统 SHALL 支持用户通过MC兑换获得JBC
2. THE 系统 SHALL 在静态奖励中提供50%的JBC价值
3. THE 系统 SHALL 在极差奖励中提供50%的JBC价值
4. THE 系统 SHALL 在赎回奖励中提供50%的JBC价值
5. THE 系统 SHALL 根据当前价格计算JBC分配数量

#### 需求 3.3: JBC销毁机制
**用户故事**: 作为系统设计者，我希望通过多种销毁机制实现JBC的通缩效应。

**验收标准**:
1. THE 系统 SHALL 在MC→JBC交换时销毁50%的税收
2. THE 系统 SHALL 在JBC→MC交换时销毁25%的税收
3. THE 系统 SHALL 支持每日销毁池子中1%的JBC代币
4. THE 系统 SHALL 确保每日销毁间隔为24小时
5. THE 系统 SHALL 在回购操作中自动销毁获得的JBC

#### 需求 3.4: JBC价格计算
**用户故事**: 作为用户，我希望JBC价格计算透明且受到保护机制约束。

**验收标准**:
1. THE 系统 SHALL 使用公式 `jbcPrice = (swapReserveMC * 1e18) / swapReserveJBC` 计算价格
2. THE 系统 SHALL 设置JBC价格下限为0.1 MC
3. THE 系统 SHALL 设置JBC价格上限为10 MC
4. WHEN 流动性不足时，THE 系统 SHALL 使用1:1的默认价格
5. THE 系统 SHALL 提供实时价格查询功能

### 4. SWAP交换系统需求

#### 需求 4.1: AMM交换机制
**用户故事**: 作为用户，我希望能够在MC和JBC之间进行自由交换。

**验收标准**:
1. THE 系统 SHALL 实现基于恒定乘积公式的AMM机制
2. THE 系统 SHALL 支持MC→JBC的直接交换（使用原生MC）
3. THE 系统 SHALL 支持JBC→MC的交换（需要JBC授权）
4. THE 系统 SHALL 在交换时收取相应的税费
5. THE 系统 SHALL 确保交换后储备量的正确更新

#### 需求 4.2: 交换税费机制
**用户故事**: 作为系统设计者，我希望通过交换税费实现代币通缩和系统收益。

**验收标准**:
1. THE 系统 SHALL 对MC→JBC交换收取50%的JBC税费
2. THE 系统 SHALL 对JBC→MC交换收取25%的JBC税费
3. THE 系统 SHALL 自动销毁所有收取的税费
4. THE 系统 SHALL 允许管理员调整税费比例
5. THE 系统 SHALL 在税费收取时触发相应事件

#### 需求 4.3: 价格影响保护
**用户故事**: 作为用户，我希望大额交换不会对价格造成过大冲击。

**验收标准**:
1. THE 系统 SHALL 设置最大价格影响限制为10%
2. WHEN 交换金额导致价格影响超过限制时，THE 系统 SHALL 拒绝交易
3. THE 系统 SHALL 计算并显示预期的价格影响
4. THE 系统 SHALL 提供价格影响的实时预览
5. THE 系统 SHALL 在价格影响过大时提供明确错误信息

#### 需求 4.4: 流动性管理
**用户故事**: 作为管理员，我希望能够管理AMM池的流动性。

**验收标准**:
1. THE 系统 SHALL 允许管理员添加MC和JBC流动性
2. THE 系统 SHALL 允许管理员提取流动性储备
3. THE 系统 SHALL 设置最小流动性阈值为1000代币
4. THE 系统 SHALL 在流动性不足时暂停交换功能
5. THE 系统 SHALL 记录所有流动性操作事件

### 5. 奖励系统需求

#### 需求 5.1: 静态奖励机制
**用户故事**: 作为用户，我希望通过质押MC代币获得稳定的静态收益。

**验收标准**:
1. THE 系统 SHALL 支持7天、15天、30天三种质押周期
2. THE 系统 SHALL 提供以下日收益率：
   - 7天周期：1.33%日收益率
   - 15天周期：1.67%日收益率
   - 30天周期：2.00%日收益率
3. THE 系统 SHALL 要求质押金额为最大单次门票金额的150%
4. THE 系统 SHALL 按50% MC + 50% JBC价值分配静态奖励
5. THE 系统 SHALL 允许用户随时领取已产生的收益

#### 需求 5.2: 直推奖励机制
**用户故事**: 作为推荐人，我希望获得直接推荐用户购买门票的奖励。

**验收标准**:
1. THE 系统 SHALL 从门票购买金额中分配25%作为直推奖励
2. WHEN 推荐人处于活跃状态时，THE 系统 SHALL 发放直推奖励
3. WHEN 推荐人非活跃时，THE 系统 SHALL 将奖励转入营销钱包
4. THE 系统 SHALL 使用纯MC发放直推奖励
5. THE 系统 SHALL 在奖励发放时触发相应事件

#### 需求 5.3: 级差奖励机制
**用户故事**: 作为团队领导者，我希望根据我的直推数量获得多层级的奖励。

**验收标准**:
1. THE 系统 SHALL 根据活跃直推数量确定奖励层数：
   - 3个及以上：15层奖励
   - 2个：10层奖励
   - 1个：5层奖励
   - 0个：无奖励
2. THE 系统 SHALL 从门票购买金额中分配15%用于级差奖励
3. THE 系统 SHALL 每层分配门票金额的1%作为奖励
4. THE 系统 SHALL 将未分配的奖励存入级差奖励池
5. THE 系统 SHALL 使用纯MC发放级差奖励

#### 需求 5.4: 极差奖励机制
**用户故事**: 作为高等级用户，我希望根据团队等级差异获得极差奖励。

**验收标准**:
1. THE 系统 SHALL 实现9级团队等级系统（V0-V9）
2. THE 系统 SHALL 根据团队人数确定用户等级：
   - V0: 0个地址，0%极差收益
   - V1: 10个地址，5%极差收益
   - V2: 30个地址，10%极差收益
   - V3: 100个地址，15%极差收益
   - V4: 300个地址，20%极差收益
   - V5: 1000个地址，25%极差收益
   - V6: 3000个地址，30%极差收益
   - V7: 10000个地址，35%极差收益
   - V8: 30000个地址，40%极差收益
   - V9: 100000个地址，45%极差收益
3. THE 系统 SHALL 计算等级差异并分配相应比例的极差奖励
4. THE 系统 SHALL 按50% MC + 50% JBC价值分配极差奖励
5. THE 系统 SHALL 在质押周期结束时释放极差奖励

### 6. 用户管理需求

#### 需求 6.1: 用户状态管理
**用户故事**: 作为系统，我需要准确跟踪和管理用户的各种状态信息。

**验收标准**:
1. THE 系统 SHALL 记录用户的推荐人信息
2. THE 系统 SHALL 跟踪用户的活跃直推数量
3. THE 系统 SHALL 统计用户的团队总人数
4. THE 系统 SHALL 记录用户的累计收益和收益上限
5. THE 系统 SHALL 维护用户的活跃状态
6. THE 系统 SHALL 记录用户的团队总业绩和各种最大值

#### 需求 6.2: 推荐关系管理
**用户故事**: 作为用户，我希望能够绑定推荐人并建立推荐关系。

**验收标准**:
1. THE 系统 SHALL 允许用户绑定推荐人（仅一次）
2. THE 系统 SHALL 防止用户自我推荐
3. THE 系统 SHALL 防止循环推荐关系
4. THE 系统 SHALL 在绑定推荐人时自动更新团队统计
5. THE 系统 SHALL 允许管理员修改用户的推荐关系

#### 需求 6.3: 活跃状态管理
**用户故事**: 作为系统，我需要准确判断和更新用户的活跃状态。

**验收标准**:
1. THE 系统 SHALL 将有门票且未退出的用户标记为活跃
2. THE 系统 SHALL 在用户状态变化时自动更新推荐人的直推计数
3. THE 系统 SHALL 在用户变为非活跃时停止相关奖励分配
4. THE 系统 SHALL 提供查询用户活跃状态的接口
5. THE 系统 SHALL 在状态变化时触发相应事件

### 7. 赎回和退出需求

#### 需求 7.1: 主动赎回功能
**用户故事**: 作为用户，我希望能够在质押到期后主动赎回本金和收益。

**验收标准**:
1. THE 系统 SHALL 允许用户在质押周期结束后进行赎回
2. THE 系统 SHALL 计算并发放所有待领取的收益
3. THE 系统 SHALL 收取1%的赎回费用
4. THE 系统 SHALL 返还扣除费用后的质押本金
5. THE 系统 SHALL 按50% MC + 50% JBC价值发放收益
6. THE 系统 SHALL 在赎回时释放相关的极差奖励

#### 需求 7.2: 自动退出机制
**用户故事**: 作为系统，我需要在用户达到收益上限时自动处理退出流程。

**验收标准**:
1. WHEN 用户累计收益达到收益上限时，THE 系统 SHALL 自动触发退出
2. THE 系统 SHALL 计算所有活跃质押的返还金额和费用
3. THE 系统 SHALL 返还扣除费用后的质押本金
4. THE 系统 SHALL 将用户设置为非活跃状态
5. THE 系统 SHALL 更新推荐人的直推计数
6. THE 系统 SHALL 在退出时触发相应事件

#### 需求 7.3: 费用处理机制
**用户故事**: 作为系统设计者，我希望合理处理赎回过程中的各种费用。

**验收标准**:
1. THE 系统 SHALL 将赎回费用添加到交换储备中
2. THE 系统 SHALL 记录用户的待退还费用金额
3. THE 系统 SHALL 在用户下次质押时自动退还费用
4. THE 系统 SHALL 确保费用计算的准确性
5. THE 系统 SHALL 在费用处理时触发相应事件

### 8. 安全和管理需求

#### 需求 8.1: 安全保护机制
**用户故事**: 作为系统，我需要提供全面的安全保护机制。

**验收标准**:
1. THE 系统 SHALL 在所有核心函数中实现重入保护
2. THE 系统 SHALL 提供紧急暂停功能
3. THE 系统 SHALL 验证所有输入参数的有效性
4. THE 系统 SHALL 实现安全的原生代币转账机制
5. THE 系统 SHALL 在转账失败时抛出明确错误

#### 需求 8.2: 管理员功能
**用户故事**: 作为管理员，我希望能够管理系统的各种参数和功能。

**验收标准**:
1. THE 系统 SHALL 允许管理员设置各种钱包地址
2. THE 系统 SHALL 允许管理员调整资金分配比例
3. THE 系统 SHALL 允许管理员设置交换税费比例
4. THE 系统 SHALL 允许管理员管理流动性储备
5. THE 系统 SHALL 允许管理员执行紧急操作
6. THE 系统 SHALL 限制管理员功能仅给合约拥有者

#### 需求 8.3: 事件和监控
**用户故事**: 作为开发者，我希望系统提供完整的事件日志用于监控和分析。

**验收标准**:
1. THE 系统 SHALL 在所有重要操作时触发相应事件
2. THE 系统 SHALL 记录用户的门票购买、质押、赎回等操作
3. THE 系统 SHALL 记录所有奖励分配和代币销毁事件
4. THE 系统 SHALL 记录管理员操作和系统状态变化
5. THE 系统 SHALL 提供详细的事件参数信息

### 9. 性能和优化需求

#### 需求 9.1: Gas优化
**用户故事**: 作为用户，我希望系统操作消耗尽可能少的Gas费用。

**验收标准**:
1. THE 系统 SHALL 通过使用原生MC代币减少50%的交易步骤
2. THE 系统 SHALL 优化合约代码以降低Gas消耗
3. THE 系统 SHALL 避免不必要的存储操作
4. THE 系统 SHALL 使用高效的算法进行计算
5. THE 系统 SHALL 在保持功能完整性的前提下最小化Gas使用

#### 需求 9.2: 流动性保护
**用户故事**: 作为系统，我需要保护AMM池的流动性稳定性。

**验收标准**:
1. THE 系统 SHALL 设置最小流动性阈值
2. THE 系统 SHALL 限制单次交换的价格影响
3. THE 系统 SHALL 在极差奖励分配中限制JBC影响为储备的5%
4. THE 系统 SHALL 在流动性不足时暂停相关功能
5. THE 系统 SHALL 提供流动性保护的实时监控

#### 需求 9.3: 系统稳定性
**用户故事**: 作为用户，我希望系统能够稳定可靠地运行。

**验收标准**:
1. THE 系统 SHALL 处理各种边界情况和异常状态
2. THE 系统 SHALL 在计算溢出时提供保护
3. THE 系统 SHALL 限制循环操作的最大迭代次数
4. THE 系统 SHALL 提供优雅的错误处理和恢复机制
5. THE 系统 SHALL 确保数据一致性和状态同步

## 业务流程总结

### 用户参与流程
1. **注册阶段**: 绑定推荐人 → `bindReferrer()`
2. **入场阶段**: 购买门票 → `buyTicket()` [原生MC支付]
3. **挖矿阶段**: 质押流动性 → `stakeLiquidity()` [原生MC质押]
4. **收益阶段**: 领取奖励 → `claimRewards()` [50% MC + 50% JBC]
5. **退出阶段**: 达到上限自动退出或主动赎回 → `redeem()`

### 奖励分配流程
1. **门票购买触发**: 直推奖励(25%) + 级差奖励(15%) + 系统分配(60%)
2. **质押挖矿产生**: 静态收益累积 + 极差奖励存储
3. **收益领取释放**: 静态收益发放 + 极差奖励释放

### 代币经济循环
1. **MC流入**: 门票购买 + 质押挖矿
2. **MC流出**: 奖励发放 + 本金返还
3. **JBC产生**: MC兑换 + 奖励分配
4. **JBC销毁**: 交换税收 + 每日销毁 + 回购销毁

## 成功标准

### 功能完整性
- ✅ 所有核心功能正常运行
- ✅ 奖励机制准确计算和分配
- ✅ 代币经济模型平衡运行
- ✅ 用户状态正确管理

### 性能指标
- ✅ 交易步骤减少50%
- ✅ Gas费用节省20-30%
- ✅ 系统响应时间优化
- ✅ 流动性保护有效

### 安全标准
- ✅ 无重入攻击漏洞
- ✅ 权限控制严格
- ✅ 数据验证完整
- ✅ 异常处理健全

### 用户体验
- ✅ 操作流程简化
- ✅ 错误提示清晰
- ✅ 状态反馈及时
- ✅ 界面响应流畅

---

**文档版本**: 1.0  
**最后更新**: 2024年12月29日  
**状态**: ✅ **需求完整，准备进入设计阶段**